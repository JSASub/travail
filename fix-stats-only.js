// fix-stats-only.js
// Correction cibl√©e uniquement sur les statistiques de sauvegarde
// √Ä ajouter SANS supprimer les autres fichiers

(function() {
    'use strict';

    // Fonction pour compter les vrais plongeurs depuis le DOM
    function getRealStats() {
        const stats = {
            plongeursEnListe: 0,
            plongeursEnPalanquees: 0,
            nombrePalanquees: 0,
            totalGeneral: 0
        };

        try {
            // Compter plongeurs en liste principale
            const listePlongeurs = document.getElementById('listePlongeurs');
            if (listePlongeurs) {
                stats.plongeursEnListe = listePlongeurs.querySelectorAll('.plongeur-item').length;
            }

            // Compter plongeurs et palanqu√©es depuis le DOM
            const palanquees = document.querySelectorAll('.palanquee');
            stats.nombrePalanquees = palanquees.length;

            palanquees.forEach(palanquee => {
                const plongeursDansPalanquee = palanquee.querySelectorAll('.palanquee-plongeur-item').length;
                stats.plongeursEnPalanquees += plongeursDansPalanquee;
            });

            stats.totalGeneral = stats.plongeursEnListe + stats.plongeursEnPalanquees;

            console.log('Stats r√©elles:', stats);
            return stats;

        } catch (error) {
            console.error('Erreur calcul stats:', error);
            return stats;
        }
    }

    // Fonction pour synchroniser les donn√©es avant sauvegarde
    function syncDataBeforeSave() {
        const realStats = getRealStats();
        
        // Mettre √† jour window.plongeurs si d√©synchronis√©
        const listePlongeurs = document.getElementById('listePlongeurs');
        if (listePlongeurs && realStats.plongeursEnListe > 0) {
            const plongeurItems = listePlongeurs.querySelectorAll('.plongeur-item');
            
            if (!window.plongeurs || window.plongeurs.length !== realStats.plongeursEnListe) {
                console.log('Resynchronisation plongeurs en cours...');
                window.plongeurs = [];
                
                plongeurItems.forEach(item => {
                    const nomEl = item.querySelector('.plongeur-nom');
                    const niveauEl = item.querySelector('.plongeur-niveau');
                    const preEl = item.querySelector('.plongeur-prerogatives');
                    
                    if (nomEl && niveauEl) {
                        window.plongeurs.push({
                            nom: nomEl.textContent.trim(),
                            niveau: niveauEl.textContent.trim(),
                            pre: preEl ? preEl.textContent.replace(/[\[\]]/g, '').trim() : ''
                        });
                    }
                });
                
                window.plongeursOriginaux = [...window.plongeurs];
                console.log(`Plongeurs synchronis√©s: ${window.plongeurs.length}`);
            }
        }

        // Mettre √† jour window.palanquees si d√©synchronis√©
        const palanqueeElements = document.querySelectorAll('.palanquee');
        if (palanqueeElements.length > 0) {
            if (!window.palanquees) window.palanquees = [];
            
            // V√©rifier chaque palanqu√©e
            palanqueeElements.forEach((palEl, index) => {
                const plongeurItems = palEl.querySelectorAll('.palanquee-plongeur-item');
                
                if (!window.palanquees[index]) {
                    window.palanquees[index] = [];
                }
                
                // Si le nombre de plongeurs diff√®re, resynchroniser
                if (window.palanquees[index].length !== plongeurItems.length) {
                    console.log(`Resynchronisation palanqu√©e ${index + 1}...`);
                    window.palanquees[index] = [];
                    
                    plongeurItems.forEach(item => {
                        const nomEl = item.querySelector('.plongeur-nom');
                        const niveauEl = item.querySelector('.plongeur-niveau');
                        const preInput = item.querySelector('.plongeur-prerogatives-editable');
                        
                        if (nomEl && niveauEl) {
                            window.palanquees[index].push({
                                nom: nomEl.textContent.trim(),
                                niveau: niveauEl.textContent.trim(),
                                pre: preInput ? preInput.value.trim() : ''
                            });
                        }
                    });
                    
                    // Capturer les param√®tres de la palanqu√©e
                    const inputs = palEl.querySelectorAll('input');
                    inputs.forEach(input => {
                        const type = input.type;
                        const placeholder = input.placeholder || '';
                        const value = input.value;
                        
                        if (type === 'time') {
                            window.palanquees[index].horaire = value;
                        } else if (placeholder.includes('Prof. pr√©vue')) {
                            window.palanquees[index].profondeurPrevue = value;
                        } else if (placeholder.includes('Dur√©e pr√©vue')) {
                            window.palanquees[index].dureePrevue = value;
                        } else if (placeholder.includes('Prof. r√©alis√©e')) {
                            window.palanquees[index].profondeurRealisee = value;
                        } else if (placeholder.includes('Dur√©e r√©alis√©e')) {
                            window.palanquees[index].dureeRealisee = value;
                        } else if (placeholder.includes('Paliers')) {
                            window.palanquees[index].paliers = value;
                        }
                    });
                }
            });
        }

        return realStats;
    }

    // Intercepter les fonctions de sauvegarde existantes
    function patchSaveFunctions() {
        // Patch pour saveSessionData
        if (typeof window.saveSessionData === 'function') {
            const originalSave = window.saveSessionData;
            window.saveSessionData = async function() {
                console.log('üîß Correction des statistiques avant sauvegarde...');
                const realStats = syncDataBeforeSave();
                
                console.log('Stats corrig√©es:', {
                    plongeursEnListe: realStats.plongeursEnListe,
                    plongeursEnPalanquees: realStats.plongeursEnPalanquees,
                    nombrePalanquees: realStats.nombrePalanquees,
                    totalGeneral: realStats.totalGeneral
                });
                
                return await originalSave.call(this);
            };
        }

        // Patch pour la fonction de sauvegarde auto
        if (typeof window.ImprovedAutoSave === 'object' && window.ImprovedAutoSave.save) {
            const originalAutoSave = window.ImprovedAutoSave.save;
            window.ImprovedAutoSave.save = function() {
                syncDataBeforeSave();
                return originalAutoSave.call(this);
            };
        }

        // Patch pour updateCompteurs
        if (typeof window.updateCompteurs === 'function') {
            const originalUpdate = window.updateCompteurs;
            window.updateCompteurs = function() {
                const realStats = getRealStats();
                
                const compteurPlongeurs = document.getElementById('compteur-plongeurs');
                if (compteurPlongeurs) {
                    compteurPlongeurs.textContent = `(${realStats.plongeursEnListe})`;
                }
                
                const compteurPalanquees = document.getElementById('compteur-palanquees');
                if (compteurPalanquees) {
                    compteurPalanquees.textContent = `(${realStats.plongeursEnPalanquees} plongeurs dans ${realStats.nombrePalanquees} palanqu√©es)`;
                }
                
                return originalUpdate.call(this);
            };
        }

        console.log('‚úÖ Fonctions de sauvegarde corrig√©es');
    }

    // Surveiller et corriger les messages d'alerte incorrects
    function fixAlertMessages() {
        const originalAlert = window.alert;
        window.alert = function(message) {
            if (typeof message === 'string' && (message.includes('0 palanqu√©e') || message.includes('7 plongeurs'))) {
                const realStats = getRealStats();
                const correctedMessage = message.replace(
                    /\d+\s*plongeurs?\s+dans\s+\d+\s+palanqu√©es?/gi,
                    `${realStats.plongeursEnPalanquees} plongeurs dans ${realStats.nombrePalanquees} palanqu√©es`
                );
                
                console.log('Message corrig√©:', correctedMessage);
                return originalAlert.call(this, correctedMessage);
            }
            return originalAlert.call(this, message);
        };

        const originalConfirm = window.confirm;
        window.confirm = function(message) {
            if (typeof message === 'string' && (message.includes('0 palanqu√©e') || message.includes('7 plongeurs'))) {
                const realStats = getRealStats();
                const correctedMessage = message.replace(
                    /\d+\s*plongeurs?\s+dans\s+\d+\s+palanqu√©es?/gi,
                    `${realStats.plongeursEnPalanquees} plongeurs dans ${realStats.nombrePalanquees} palanqu√©es`
                );
                
                console.log('Confirmation corrig√©e:', correctedMessage);
                return originalConfirm.call(this, correctedMessage);
            }
            return originalConfirm.call(this, message);
        };
    }

    // Fonction pour forcer la synchronisation manuelle
    window.forceSyncJSAS = function() {
        const realStats = syncDataBeforeSave();
        console.log('üîÑ Synchronisation forc√©e:', realStats);
        
        if (typeof window.updateCompteurs === 'function') {
            window.updateCompteurs();
        }
        
        return realStats;
    };

    // Fonction de diagnostic
    window.diagJSAS = function() {
        const realStats = getRealStats();
        const memoryStats = {
            plongeurs: window.plongeurs ? window.plongeurs.length : 0,
            palanquees: window.palanquees ? window.palanquees.length : 0
        };
        
        console.log('üìä DIAGNOSTIC JSAS');
        console.log('DOM (r√©el):', realStats);
        console.log('M√©moire:', memoryStats);
        
        if (realStats.totalGeneral !== (memoryStats.plongeurs + realStats.plongeursEnPalanquees)) {
            console.log('‚ö†Ô∏è D√âSYNCHRONISATION D√âTECT√âE');
            console.log('üí° Ex√©cutez: forceSyncJSAS()');
        } else {
            console.log('‚úÖ Donn√©es synchronis√©es');
        }
        
        return { realStats, memoryStats };
    };

    // Initialisation
    function init() {
        console.log('üîß Initialisation correctif statistiques...');
        
        // Attendre que les autres scripts soient charg√©s
        setTimeout(() => {
            patchSaveFunctions();
            fixAlertMessages();
            
            // Forcer une premi√®re synchronisation
            setTimeout(() => {
                syncDataBeforeSave();
                if (typeof window.updateCompteurs === 'function') {
                    window.updateCompteurs();
                }
            }, 1000);
            
        }, 500);
        
        console.log('‚úÖ Correctif statistiques install√©');
        console.log('üí° Utilisez diagJSAS() pour diagnostiquer');
        console.log('üí° Utilisez forceSyncJSAS() pour forcer la sync');
    }

    // Auto-initialisation
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

})();