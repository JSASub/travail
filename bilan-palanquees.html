<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bilan Global Palanqu√©es - JSAS</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  
  <style>
    :root {
      --primary-blue: #007bff;
      --success-green: #28a745;
      --danger-red: #dc3545;
      --dark-blue: #003366;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #f7fcff; color: #333; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .header { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid var(--primary-blue); }
    .logo { height: 60px; width: auto; }
    h1 { color: var(--dark-blue); font-size: 28px; }
    .filters { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
    .filter-row { display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 15px; }
    .filter-group { flex: 1; min-width: 200px; }
    .filter-group label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--dark-blue); }
    .filter-group input, .filter-group select { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; }
    .filter-group input:focus, .filter-group select:focus { outline: none; border-color: var(--primary-blue); }
    .btn { padding: 12px 24px; border: none; border-radius: 5px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
    .btn-primary { background: var(--primary-blue); color: white; }
    .btn-primary:hover { background: #0056b3; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,123,255,0.3); }
    .btn-success { background: var(--success-green); color: white; }
    .btn-success:hover { background: #1e7e34; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #545b62; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .stat-card { background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 2px solid var(--primary-blue); border-radius: 8px; padding: 20px; text-align: center; }
    .stat-value { font-size: 32px; font-weight: bold; color: var(--dark-blue); }
    .stat-label { font-size: 14px; color: #666; margin-top: 5px; }
    .loading { text-align: center; padding: 40px; color: #666; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .table-container { overflow-x: auto; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background: var(--dark-blue); color: white; padding: 12px 8px; text-align: left; font-weight: bold; position: sticky; top: 0; z-index: 10; }
    td { padding: 10px 8px; border-bottom: 1px solid #ddd; }
    tr:hover { background: #f8f9fa; }
    tr:nth-child(even) { background: #fafafa; }
    .niveau-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; color: white; background: var(--success-green); }
    .alert { padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .export-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .back-link { display: inline-block; margin-bottom: 20px; color: var(--primary-blue); text-decoration: none; font-weight: bold; }
    .back-link:hover { text-decoration: underline; }
    /* Style pour le filtre plongeur avec effet highlight */
    .filter-group.plongeur-filter { border-left: 3px solid var(--success-green); padding-left: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" class="back-link">‚Üê Retour √† l'application</a>

    <div class="header">
      <img src="images/logo-jsas.png" alt="Logo JSAS" class="logo">
      <div>
        <h1>Bilan Global des Palanqu√©es</h1>
        <p style="color: #666; margin-top: 5px;">Analyse consolid√©e des sessions de plong√©e</p>
      </div>
    </div>

    <div class="filters">
      <div class="filter-row">
        <div class="filter-group">
          <label for="date-debut">Date de d√©but</label>
          <input type="date" id="date-debut">
        </div>
        <div class="filter-group">
          <label for="date-fin">Date de fin</label>
          <input type="date" id="date-fin">
        </div>
        <div class="filter-group">
          <label for="filtre-dp">Directeur de Plong√©e</label>
          <select id="filtre-dp"><option value="">Tous les DP</option></select>
        </div>
        <div class="filter-group">
          <label for="filtre-lieu">Lieu</label>
          <select id="filtre-lieu"><option value="">Tous les lieux</option></select>
        </div>
      </div>
      <div class="filter-row">
        <div class="filter-group plongeur-filter">
          <label for="filtre-plongeur">üîç Nom du plongeur</label>
          <input type="text" id="filtre-plongeur" placeholder="Rechercher un plongeur...">
        </div>
      </div>
      <div class="filter-row">
        <button class="btn btn-primary" onclick="chargerBilan()">G√©n√©rer le bilan</button>
        <button class="btn btn-secondary" onclick="reinitialiserFiltres()">R√©initialiser</button>
      </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>Chargement des donn√©es...</p>
    </div>

    <div id="results" style="display: none;">
      <div class="stats" id="stats-container"></div>
      <div class="export-buttons">
        <button class="btn btn-success" onclick="exporterCSV()">üìä Exporter CSV</button>
        <button class="btn btn-success" onclick="exporterExcel()">üìó Exporter Excel</button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>DP</th><th>Lieu</th><th>Session</th><th>Palanqu√©e</th><th>Plongeur</th><th>Pr√©rogatives</th><th>Niveau</th><th>Horaire</th><th>Prof. Pr√©vue [m]</th><th>Dur√©e Pr√©vue [min]</th><th>Prof. R√©alis√©e [m]</th><th>Dur√©e R√©alis√©e [min]</th><th>Paliers</th>
            </tr>
          </thead>
          <tbody id="bilan-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="no-data" class="alert alert-info" style="display: none;">Aucune donn√©e disponible pour la p√©riode s√©lectionn√©e.</div>
    <div id="error" class="alert alert-danger" style="display: none;"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA9FO6BiHkm7dOQ3Z4-wpPQRgnsGKg3pmM",
      authDomain: "palanquees-jsas.firebaseapp.com",
      databaseURL: "https://palanquees-jsas-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "palanquees-jsas",
      storageBucket: "palanquees-jsas.firebasestorage.app",
      messagingSenderId: "284449736616",
      appId: "1:284449736616:web:a0949a9b669def06323f9d"
    };

    let app, db;
    let bilanData = [];
    
    const ORDRE_NIVEAUX = ['E4', 'E3', 'E2', 'N4/GP', 'GP', 'N4', 'N3', 'N2', 'N1', 'Plg.Or', 'Plg.Ar', 'Plg.Br', 'D√©b.', 'd√©butant', 'D√©b'];
    
    function trierPlongeursParNiveau(plongeurs) {
      return [...plongeurs].sort((a, b) => {
        const indexA = ORDRE_NIVEAUX.indexOf(a.niveau);
        const indexB = ORDRE_NIVEAUX.indexOf(b.niveau);
        const posA = indexA === -1 ? 999 : indexA;
        const posB = indexB === -1 ? 999 : indexB;
        if (posA === posB) {
          return a.nom.localeCompare(b.nom, 'fr', { sensitivity: 'base' });
        }
        return posA - posB;
      });
    }
    
    // Fonction pour normaliser le texte (enlever accents et mettre en minuscules)
    function normaliserTexte(texte) {
      return texte.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    }
    
    try {
      app = firebase.initializeApp(firebaseConfig);
      db = firebase.database();
    } catch (error) {
      console.error('Erreur Firebase:', error);
    }

    async function chargerFiltres() {
      const snapshot = await db.ref('sessions').once('value');
      const sessions = snapshot.val();
      if (!sessions) return;

      const dps = new Set();
      const lieux = new Set();

      Object.values(sessions).forEach(session => {
        if (session.directeurPlongee) dps.add(session.directeurPlongee);
        if (session.lieu) lieux.add(session.lieu);
      });

      const dpSelect = document.getElementById('filtre-dp');
      const lieuSelect = document.getElementById('filtre-lieu');

      [...dps].sort().forEach(dp => {
        const option = document.createElement('option');
        option.value = dp;
        option.textContent = dp;
        dpSelect.appendChild(option);
      });

      [...lieux].sort().forEach(lieu => {
        const option = document.createElement('option');
        option.value = lieu;
        option.textContent = lieu;
        lieuSelect.appendChild(option);
      });
    }

    async function chargerBilan() {
      cacherErreur();
      afficherLoading(true);
      document.getElementById('results').style.display = 'none';
      document.getElementById('no-data').style.display = 'none';

      try {
        const dateDebut = document.getElementById('date-debut').value;
        const dateFin = document.getElementById('date-fin').value;
        const filtreDP = document.getElementById('filtre-dp').value;
        const filtreLieu = document.getElementById('filtre-lieu').value;
        const filtrePlongeur = normaliserTexte(document.getElementById('filtre-plongeur').value.trim());

        if (!dateDebut || !dateFin) {
          afficherErreur('Veuillez s√©lectionner une p√©riode.');
          return;
        }

        const snapshot = await db.ref('sessions').once('value');
        const sessions = snapshot.val();

        if (!sessions) {
          afficherAucuneDonnee();
          return;
        }

        bilanData = [];
        let totalPlongeurs = 0;
        let totalPalanquees = 0;
        const plongeursUniques = new Set();

        Object.entries(sessions).forEach(([sessionId, session]) => {
          if (!session.date || session.date < dateDebut || session.date > dateFin) return;
          if (filtreDP && session.directeurPlongee !== filtreDP) return;
          if (filtreLieu && session.lieu !== filtreLieu) return;

          if (session.palanquees) {
            Object.entries(session.palanquees).forEach(([palanqueeId, palanquee]) => {
              if (!palanquee.plongeurs) return;

              const plongeursArray = Object.values(palanquee.plongeurs);
              
              // Si un filtre plongeur est actif, v√©rifier que la palanqu√©e contient ce plongeur
              let plongeursTries = trierPlongeursParNiveau(plongeursArray);
              
              if (filtrePlongeur) {
                const plongeursTrouv√©s = plongeursTries.filter(p => 
                  normaliserTexte(p.nom).includes(filtrePlongeur)
                );
                
                // Si aucun plongeur ne correspond, ne pas inclure cette palanqu√©e
                if (plongeursTrouv√©s.length === 0) return;
                
                // Si un filtre est actif, afficher uniquement les plongeurs correspondants
                plongeursTries = plongeursTrouv√©s;
              }

              totalPalanquees++;
              totalPlongeurs += plongeursTries.length;
              plongeursTries.forEach(p => plongeursUniques.add(p.nom));

              bilanData.push({
                date: session.date,
                dp: session.directeurPlongee || '',
                lieu: session.lieu || '',
                typeSession: session.typeSession || '',
                numeroPalanquee: palanquee.numeroPalanquee || '',
                horaire: palanquee.horaire || '',
                profPrevue: palanquee.profondeurPrevue || '',
                dureePrevue: palanquee.dureePrevue || '',
                profRealisee: palanquee.profondeurRealisee || '',
                dureeRealisee: palanquee.dureeRealisee || '',
                paliers: palanquee.paliers || 'Non',
                plongeurs: plongeursTries
              });
            });
          }
        });

        if (bilanData.length === 0) {
          afficherAucuneDonnee();
          return;
        }

        bilanData.sort((a, b) => {
          if (a.date !== b.date) return a.date.localeCompare(b.date);
          if (a.dp !== b.dp) return a.dp.localeCompare(b.dp);
          if (a.typeSession !== b.typeSession) return a.typeSession.localeCompare(b.typeSession);
          return (a.numeroPalanquee || 0) - (b.numeroPalanquee || 0);
        });

        afficherStats(totalPlongeurs, totalPalanquees, plongeursUniques.size);
        afficherTableau();
        document.getElementById('results').style.display = 'block';
      } catch (error) {
        afficherErreur('Erreur lors du chargement: ' + error.message);
      } finally {
        afficherLoading(false);
      }
    }

    function afficherStats(totalPlongeurs, totalPalanquees, plongeursUniques) {
      const statsContainer = document.getElementById('stats-container');
      statsContainer.innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${totalPalanquees}</div>
          <div class="stat-label">Palanqu√©es</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${totalPlongeurs}</div>
          <div class="stat-label">Total Plong√©es</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${plongeursUniques}</div>
          <div class="stat-label">Plongeurs Uniques</div>
        </div>
      `;
    }

    function afficherTableau() {
      const tbody = document.getElementById('bilan-tbody');
      tbody.innerHTML = '';

      let sessionPrecedente = null;

      bilanData.forEach(row => {
        const sessionActuelle = `${row.date}_${row.dp}_${row.typeSession}`;

        if (sessionPrecedente !== null && sessionPrecedente !== sessionActuelle) {
          const plongeursDansSession = bilanData.filter(r => 
            `${r.date}_${r.dp}_${r.typeSession}` === sessionPrecedente
          ).reduce((sum, r) => sum + r.plongeurs.length, 0);

          const separateur = document.createElement('tr');
          separateur.style.background = '#FF6B00';
          separateur.style.height = '8px';
          separateur.innerHTML = '<td colspan="14"></td>';
          tbody.appendChild(separateur);

          const totalSession = document.createElement('tr');
          totalSession.style.background = '#d4edda';
          totalSession.style.fontWeight = 'bold';
          totalSession.innerHTML = `
            <td colspan="2">TOTAL SESSION:</td>
            <td colspan="12">${plongeursDansSession} plongeur${plongeursDansSession > 1 ? 's' : ''}</td>
          `;
          tbody.appendChild(totalSession);

          const espaceur = document.createElement('tr');
          espaceur.style.height = '10px';
          espaceur.innerHTML = '<td colspan="14"></td>';
          tbody.appendChild(espaceur);
        }

        row.plongeurs.forEach((plongeur, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            ${idx === 0 ? `<td>${row.date}</td>` : '<td></td>'}
            ${idx === 0 ? `<td>${row.dp}</td>` : '<td></td>'}
            ${idx === 0 ? `<td>${row.lieu}</td>` : '<td></td>'}
            ${idx === 0 ? `<td>${row.typeSession}</td>` : '<td></td>'}
            ${idx === 0 ? `<td>${row.numeroPalanquee}</td>` : '<td></td>'}
            <td>${plongeur.nom}</td>
            <td>${plongeur.pre || ''}</td>
            <td><span class="niveau-badge">${plongeur.niveau}</span></td>
            ${idx === 0 ? `<td>${row.horaire}</td>` : '<td></td>'}
            ${idx === 0 ? `<td>${row.profPrevue}</td>` : '<td></td>'}
            ${idx === 0 ? `<td>${row.dureePrevue}</td>` : '<td></td>'}
            ${idx === 0 ? `<td>${row.profRealisee}</td>` : '<td></td>'}
            ${idx === 0 ? `<td>${row.dureeRealisee}</td>` : '<td></td>'}
            ${idx === 0 ? `<td>${row.paliers}</td>` : '<td></td>'}
          `;
          tbody.appendChild(tr);
        });

        const totalPalanquee = document.createElement('tr');
        totalPalanquee.style.background = '#e8f4f8';
        totalPalanquee.style.fontWeight = 'bold';
        totalPalanquee.innerHTML = `
          <td colspan="2">Total palanqu√©e:</td>
          <td colspan="12">${row.plongeurs.length} plongeur${row.plongeurs.length > 1 ? 's' : ''}</td>
        `;
        tbody.appendChild(totalPalanquee);

        sessionPrecedente = sessionActuelle;
      });

      if (bilanData.length > 0) {
        const dernierIndex = bilanData.length - 1;
        const derniereSession = `${bilanData[dernierIndex].date}_${bilanData[dernierIndex].dp}_${bilanData[dernierIndex].typeSession}`;
        const plongeursDansSession = bilanData.filter(r => 
          `${r.date}_${r.dp}_${r.typeSession}` === derniereSession
        ).reduce((sum, r) => sum + r.plongeurs.length, 0);

        const separateur = document.createElement('tr');
        separateur.style.background = '#FF6B00';
        separateur.style.height = '8px';
        separateur.innerHTML = '<td colspan="14"></td>';
        tbody.appendChild(separateur);

        const totalSession = document.createElement('tr');
        totalSession.style.background = '#d4edda';
        totalSession.style.fontWeight = 'bold';
        totalSession.innerHTML = `
          <td colspan="2">TOTAL SESSION:</td>
          <td colspan="12">${plongeursDansSession} plongeur${plongeursDansSession > 1 ? 's' : ''}</td>
        `;
        tbody.appendChild(totalSession);
      }
    }

    function exporterCSV() {
      let csv = 'Date;DP;Lieu;Session;Palanqu√©e;Plongeur;Pr√©rogatives;Niveau;Horaire;Prof. Pr√©vue [m];Dur√©e Pr√©vue [min];Prof. R√©alis√©e [m];Dur√©e R√©alis√©e [min];Paliers\n';
      
      bilanData.forEach(row => {
        row.plongeurs.forEach((plongeur, idx) => {
          csv += idx === 0 
            ? `${row.date};${row.dp};${row.lieu};${row.typeSession};${row.numeroPalanquee};`
            : ';;;;;';
          csv += `${plongeur.nom};${plongeur.pre || ''};${plongeur.niveau};`;
          csv += idx === 0 
            ? `${row.horaire};${row.profPrevue};${row.dureePrevue};${row.profRealisee};${row.dureeRealisee};${row.paliers}\n`
            : ';;;;;\n';
        });
      });

      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'bilan-palanquees.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function exporterExcel() {
      let html = `<?xml version="1.0" encoding="UTF-8"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:x="urn:schemas-microsoft-com:office:excel">
 <Styles>
  <Style ss:ID="titre">
   <Font ss:Bold="1" ss:Size="14" ss:Color="#003366"/>
   <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
  </Style>
  <Style ss:ID="entete">
   <Interior ss:Color="#007bff" ss:Pattern="Solid"/>
   <Font ss:Bold="1" ss:Color="#FFFFFF"/>
   <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="2"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="2"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
  </Style>
  <Style ss:ID="totalPalanquee">
   <Interior ss:Color="#e8f4f8" ss:Pattern="Solid"/>
   <Font ss:Bold="1" ss:Size="10"/>
  </Style>
  <Style ss:ID="totalSession">
   <Interior ss:Color="#d4edda" ss:Pattern="Solid"/>
   <Font ss:Bold="1"/>
  </Style>
  <Style ss:ID="separateur">
   <Interior ss:Color="#FF6B00" ss:Pattern="Solid"/>
  </Style>
 </Styles>
 <Worksheet ss:Name="Bilan Palanqu√©es">
  <WorksheetOptions xmlns="urn:schemas-microsoft-com:office:excel">
   <PageSetup>
    <Layout x:Orientation="Landscape"/>
    <Header x:Margin="0"/>
    <Footer x:Margin="0"/>
    <PageMargins x:Bottom="0.3" x:Left="0.3" x:Right="0.3" x:Top="0.3"/>
    <FitToPage/>
    <Print>
     <PaperSizeIndex>9</PaperSizeIndex>
     <ValidPrinterInfo/>
     <Scale>80</Scale>
    </Print>
   </PageSetup>
  </WorksheetOptions>
  <Table>`;
      
      // Titre
      html += '<Row ss:Height="30"><Cell ss:MergeAcross="13" ss:StyleID="titre"><Data ss:Type="String">Bilan Global des Palanqu√©es - JSAS</Data></Cell></Row>';
      html += '<Row ss:Height="10"></Row>';
      
      // En-t√™tes
      html += '<Row>';
      ['Date', 'DP', 'Lieu', 'Session', 'Palanqu√©e', 'Plongeur', 'Pr√©rogatives', 'Niveau', 'Horaire', 'Prof. Pr√©vue [m]', 'Dur√©e Pr√©vue [min]', 'Prof. R√©alis√©e [m]', 'Dur√©e R√©alis√©e [min]', 'Paliers'].forEach(entete => {
        html += `<Cell ss:StyleID="entete"><Data ss:Type="String">${entete}</Data></Cell>`;
      });
      html += '</Row>';
      
      let sessionPrecedente = null;
      
      bilanData.forEach(row => {
        const sessionActuelle = `${row.date}_${row.dp}_${row.typeSession}`;
        
        if (sessionPrecedente !== null && sessionPrecedente !== sessionActuelle) {
          const plongeursDansSession = bilanData.filter(r => 
            `${r.date}_${r.dp}_${r.typeSession}` === sessionPrecedente
          ).reduce((sum, r) => sum + r.plongeurs.length, 0);
          
          html += '<Row><Cell ss:MergeAcross="1" ss:StyleID="totalSession"><Data ss:Type="String">TOTAL SESSION:</Data></Cell>';
          html += `<Cell ss:MergeAcross="11" ss:StyleID="totalSession"><Data ss:Type="String">${plongeursDansSession} plongeur${plongeursDansSession > 1 ? 's' : ''}</Data></Cell></Row>`;
          html += '<Row ss:Height="10"><Cell ss:MergeAcross="13" ss:StyleID="separateur"></Cell></Row>';
        }
        
        row.plongeurs.forEach((plongeur, idx) => {
          html += '<Row>';
          html += idx === 0 ? `<Cell><Data ss:Type="String">${row.date}</Data></Cell>` : '<Cell></Cell>';
          html += idx === 0 ? `<Cell><Data ss:Type="String">${row.dp}</Data></Cell>` : '<Cell></Cell>';
          html += idx === 0 ? `<Cell><Data ss:Type="String">${row.lieu}</Data></Cell>` : '<Cell></Cell>';
          html += idx === 0 ? `<Cell><Data ss:Type="String">${row.typeSession}</Data></Cell>` : '<Cell></Cell>';
          html += idx === 0 ? `<Cell><Data ss:Type="Number">${row.numeroPalanquee}</Data></Cell>` : '<Cell></Cell>';
          html += `<Cell><Data ss:Type="String">${plongeur.nom}</Data></Cell>`;
          html += `<Cell><Data ss:Type="String">${plongeur.pre || ''}</Data></Cell>`;
          html += `<Cell><Data ss:Type="String">${plongeur.niveau}</Data></Cell>`;
          html += idx === 0 ? `<Cell><Data ss:Type="String">${row.horaire}</Data></Cell>` : '<Cell></Cell>';
          html += idx === 0 ? `<Cell><Data ss:Type="String">${row.profPrevue}</Data></Cell>` : '<Cell></Cell>';
          html += idx === 0 ? `<Cell><Data ss:Type="String">${row.dureePrevue}</Data></Cell>` : '<Cell></Cell>';
          html += idx === 0 ? `<Cell><Data ss:Type="String">${row.profRealisee}</Data></Cell>` : '<Cell></Cell>';
          html += idx === 0 ? `<Cell><Data ss:Type="String">${row.dureeRealisee}</Data></Cell>` : '<Cell></Cell>';
          html += idx === 0 ? `<Cell><Data ss:Type="String">${row.paliers}</Data></Cell>` : '<Cell></Cell>';
          html += '</Row>';
        });
        
        html += '<Row><Cell ss:MergeAcross="1" ss:StyleID="totalPalanquee"><Data ss:Type="String">Total palanqu√©e:</Data></Cell>';
        html += `<Cell ss:MergeAcross="11" ss:StyleID="totalPalanquee"><Data ss:Type="String">${row.plongeurs.length} plongeur${row.plongeurs.length > 1 ? 's' : ''}</Data></Cell></Row>`;
        
        sessionPrecedente = sessionActuelle;
      });
      
      if (bilanData.length > 0) {
        const dernierIndex = bilanData.length - 1;
        const derniereSession = `${bilanData[dernierIndex].date}_${bilanData[dernierIndex].dp}_${bilanData[dernierIndex].typeSession}`;
        const plongeursDansSession = bilanData.filter(r => 
          `${r.date}_${r.dp}_${r.typeSession}` === derniereSession
        ).reduce((sum, r) => sum + r.plongeurs.length, 0);
        
        html += '<Row><Cell ss:MergeAcross="1" ss:StyleID="totalSession"><Data ss:Type="String">TOTAL SESSION:</Data></Cell>';
        html += `<Cell ss:MergeAcross="11" ss:StyleID="totalSession"><Data ss:Type="String">${plongeursDansSession} plongeur${plongeursDansSession > 1 ? 's' : ''}</Data></Cell></Row>`;
      }
      
      html += '</Table>';
      html += '</Worksheet></Workbook>';
      
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + html], { type: 'application/vnd.ms-excel' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'bilan-palanquees.xls';
      a.click();
      URL.revokeObjectURL(url);
    }

    function afficherLoading(show) { document.getElementById('loading').style.display = show ? 'block' : 'none'; }
    function afficherAucuneDonnee() {
      document.getElementById('results').style.display = 'none';
      document.getElementById('no-data').style.display = 'block';
      afficherLoading(false);
    }
    function afficherErreur(message) {
      document.getElementById('error').textContent = message;
      document.getElementById('error').style.display = 'block';
      afficherLoading(false);
    }
    function cacherErreur() { document.getElementById('error').style.display = 'none'; }
    function reinitialiserFiltres() {
      const aujourdhui = new Date();
      const ilYaUnMois = new Date();
      ilYaUnMois.setMonth(ilYaUnMois.getMonth() - 1);
      document.getElementById('date-debut').valueAsDate = ilYaUnMois;
      document.getElementById('date-fin').valueAsDate = aujourdhui;
      document.getElementById('filtre-dp').value = '';
      document.getElementById('filtre-lieu').value = '';
      document.getElementById('filtre-plongeur').value = '';
      document.getElementById('results').style.display = 'none';
      document.getElementById('no-data').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', async function() {
      try {
        if (!db) { afficherErreur('Firebase non disponible'); return; }
        const aujourdhui = new Date();
        const ilYaUnMois = new Date();
        ilYaUnMois.setMonth(ilYaUnMois.getMonth() - 1);
        document.getElementById('date-fin').valueAsDate = aujourdhui;
        document.getElementById('date-debut').valueAsDate = ilYaUnMois;
        await chargerFiltres();
      } catch (error) {
        afficherErreur('Erreur: ' + error.message);
      }
    });
  </script>
</body>
</html>