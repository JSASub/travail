<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bilan Global Palanqu√©es - JSAS</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  
  <!-- Configuration Firebase -->
  <script src="js/config-firebase.js"></script>
  
  <style>
    :root {
      --primary-blue: #007bff;
      --success-green: #28a745;
      --danger-red: #dc3545;
      --dark-blue: #003366;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f7fcff;
      color: #333;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--primary-blue);
    }

    .logo {
      height: 60px;
      width: auto;
    }

    h1 {
      color: var(--dark-blue);
      font-size: 28px;
    }

    .filters {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .filter-row {
      display: flex;
      gap: 20px;
      align-items: flex-end;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    .filter-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--dark-blue);
    }

    .filter-group input,
    .filter-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: var(--primary-blue);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: var(--primary-blue);
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,123,255,0.3);
    }

    .btn-success {
      background: var(--success-green);
      color: white;
    }

    .btn-success:hover {
      background: #1e7e34;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #545b62;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      border: 2px solid var(--primary-blue);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: var(--dark-blue);
    }

    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-blue);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .table-container {
      overflow-x: auto;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th {
      background: var(--dark-blue);
      color: white;
      padding: 12px 8px;
      text-align: left;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td {
      padding: 10px 8px;
      border-bottom: 1px solid #ddd;
    }

    tr:hover {
      background: #f8f9fa;
    }

    tr:nth-child(even) {
      background: #fafafa;
    }

    .niveau-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      color: white;
      background: var(--success-green);
    }

    .alert {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .export-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: var(--primary-blue);
      text-decoration: none;
      font-weight: bold;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .filter-row {
        flex-direction: column;
      }

      .stats {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 11px;
      }

      th, td {
        padding: 8px 4px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" class="back-link">‚Üê Retour √† l'application</a>

    <div class="header">
      <img src="images/logo-jsas.png" alt="Logo JSAS" class="logo">
      <div>
        <h1>Bilan Global des Palanqu√©es</h1>
        <p style="color: #666; margin-top: 5px;">Analyse consolid√©e des sessions de plong√©e</p>
      </div>
    </div>

    <div class="filters">
      <div class="filter-row">
        <div class="filter-group">
          <label for="date-debut">Date de d√©but</label>
          <input type="date" id="date-debut">
        </div>
        <div class="filter-group">
          <label for="date-fin">Date de fin</label>
          <input type="date" id="date-fin">
        </div>
        <div class="filter-group">
          <label for="filtre-dp">Directeur de Plong√©e</label>
          <select id="filtre-dp">
            <option value="">Tous les DP</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filtre-lieu">Lieu</label>
          <select id="filtre-lieu">
            <option value="">Tous les lieux</option>
          </select>
        </div>
      </div>
      <div class="filter-row">
        <button class="btn btn-primary" onclick="chargerBilan()">G√©n√©rer le bilan</button>
        <button class="btn btn-secondary" onclick="reinitialiserFiltres()">R√©initialiser</button>
      </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>Chargement des donn√©es...</p>
    </div>

    <div id="results" style="display: none;">
      <div class="stats" id="stats-container"></div>

      <div class="export-buttons">
        <button class="btn btn-success" onclick="exporterCSV()">üìä Exporter CSV</button>
        <button class="btn btn-success" onclick="exporterExcel()">üìó Exporter Excel</button>
      </div>

      <div class="table-container">
        <table id="bilan-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>DP</th>
              <th>Lieu</th>
              <th>Session</th>
              <th>Palanqu√©e</th>
              <th>Horaire</th>
              <th>Plongeurs</th>
              <th>Niveaux</th>
              <th>Prof. Pr√©vue</th>
              <th>Dur√©e Pr√©vue</th>
              <th>Prof. R√©alis√©e</th>
              <th>Dur√©e R√©alis√©e</th>
              <th>Paliers</th>
            </tr>
          </thead>
          <tbody id="bilan-tbody">
          </tbody>
        </table>
      </div>
    </div>

    <div id="no-data" class="alert alert-info" style="display: none;">
      Aucune donn√©e disponible pour la p√©riode s√©lectionn√©e.
    </div>

    <div id="error" class="alert alert-danger" style="display: none;"></div>
  </div>

  <script>
    // Attendre l'initialisation compl√®te de Firebase depuis config-firebase.js
    // Variables (pas de red√©claration de db)
  let db;
  let firebaseReady = false;
  let sessionsData = [];
  let bilanData = [];

  function attendreFirebase() {
    return new Promise((resolve, reject) => {
      let tentatives = 0;
      const maxTentatives = 50;
      
      const checkFirebase = setInterval(() => {
        tentatives++;
        
        if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
          clearInterval(checkFirebase);
          db = firebase.database();
          firebaseReady = true;
          console.log('‚úÖ Firebase pr√™t');
          resolve();
          return;
        }
        
        if (tentatives >= maxTentatives) {
          clearInterval(checkFirebase);
          reject(new Error('Timeout Firebase'));
        }
      }, 100);
    });
  }

    //let sessionsData = [];
    let bilanData = [];

    // Initialisation
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        await attendreFirebase();
        
        if (!db || !firebaseReady) {
          afficherErreur('Impossible de se connecter √† Firebase');
          return;
        }
        
        console.log('üî• Firebase connect√©');
        
        const aujourdhui = new Date();
        const ilYaUnMois = new Date();
        ilYaUnMois.setMonth(ilYaUnMois.getMonth() - 1);
        
        document.getElementById('date-fin').valueAsDate = aujourdhui;
        document.getElementById('date-debut').valueAsDate = ilYaUnMois;

        await chargerFiltres();
        
      } catch (error) {
        console.error('‚ùå Erreur initialisation:', error);
        afficherErreur('Erreur d\'initialisation Firebase: ' + error.message);
      }
    });

    // Charger les options des filtres
    async function chargerFiltres() {
      if (!db) {
        console.error('DB non disponible');
        return;
      }
      
      try {
        console.log('üìã Chargement des filtres...');
        const snapshot = await db.ref('sessions').once('value');
        
        if (!snapshot.exists()) {
          console.log('‚ö†Ô∏è Aucune session trouv√©e');
          return;
        }

        const sessions = snapshot.val();
        console.log('‚úÖ Sessions trouv√©es:', Object.keys(sessions).length);
        
        const dps = new Set();
        const lieux = new Set();

        Object.values(sessions).forEach(session => {
          if (session.meta) {
            if (session.meta.dp) dps.add(session.meta.dp);
            if (session.meta.lieu) lieux.add(session.meta.lieu);
          }
        });

        console.log('DPs:', dps.size, 'Lieux:', lieux.size);

        const dpSelect = document.getElementById('filtre-dp');
        Array.from(dps).sort().forEach(dp => {
          const option = document.createElement('option');
          option.value = dp;
          option.textContent = dp;
          dpSelect.appendChild(option);
        });

        const lieuSelect = document.getElementById('filtre-lieu');
        Array.from(lieux).sort().forEach(lieu => {
          const option = document.createElement('option');
          option.value = lieu;
          option.textContent = lieu;
          lieuSelect.appendChild(option);
        });

      } catch (error) {
        console.error('‚ùå Erreur chargement filtres:', error);
      }
    }

    // Charger et g√©n√©rer le bilan
    async function chargerBilan() {
      const dateDebut = document.getElementById('date-debut').value;
      const dateFin = document.getElementById('date-fin').value;
      const filtreDP = document.getElementById('filtre-dp').value;
      const filtreLieu = document.getElementById('filtre-lieu').value;

      if (!dateDebut || !dateFin) {
        afficherErreur('Veuillez s√©lectionner les dates de d√©but et de fin');
        return;
      }

      if (new Date(dateDebut) > new Date(dateFin)) {
        afficherErreur('La date de d√©but doit √™tre ant√©rieure √† la date de fin');
        return;
      }

      afficherLoading(true);
      cacherErreur();

      const timeoutId = setTimeout(() => {
        afficherLoading(false);
        afficherErreur('Le chargement prend trop de temps. V√©rifiez votre connexion.');
      }, 10000);

      try {
        const snapshot = await db.ref('sessions').once('value');
        clearTimeout(timeoutId);
        
        if (!snapshot.exists()) {
          console.log('Aucune session dans Firebase');
          afficherAucuneDonnee();
          return;
        }

        const sessions = snapshot.val();
        console.log('Sessions trouv√©es:', Object.keys(sessions).length);
        bilanData = [];

        Object.entries(sessions).forEach(([key, session]) => {
          if (!session.meta || !session.palanquees) return;

          const sessionDate = session.meta.date;
          
          if (sessionDate < dateDebut || sessionDate > dateFin) return;
          if (filtreDP && session.meta.dp !== filtreDP) return;
          if (filtreLieu && session.meta.lieu !== filtreLieu) return;

          session.palanquees.forEach((palanquee, idx) => {
            if (!palanquee || !palanquee.plongeurs) return;

            bilanData.push({
              date: session.meta.date,
              dp: session.meta.dp,
              lieu: session.meta.lieu,
              typeSession: session.meta.plongee || 'matin',
              numeroPalanquee: idx + 1,
              horaire: palanquee.parametres?.horaire || '',
              plongeurs: palanquee.plongeurs,
              profPrevue: palanquee.parametres?.profondeurPrevue || '',
              dureePrevue: palanquee.parametres?.dureePrevue || '',
              profRealisee: palanquee.parametres?.profondeurRealisee || '',
              dureeRealisee: palanquee.parametres?.dureeRealisee || '',
              paliers: palanquee.parametres?.paliers || ''
            });
          });
        });

        if (bilanData.length === 0) {
          console.log('Aucune donn√©e apr√®s filtrage');
          afficherAucuneDonnee();
          return;
        }

        afficherStatistiques();
        afficherTableau();
        
        document.getElementById('results').style.display = 'block';
        document.getElementById('no-data').style.display = 'none';

      } catch (error) {
        clearTimeout(timeoutId);
        console.error('Erreur compl√®te:', error);
        afficherErreur('Erreur: ' + error.message);
      } finally {
        afficherLoading(false);
      }
    }

    // Afficher les statistiques
    function afficherStatistiques() {
      const statsContainer = document.getElementById('stats-container');
      
      const totalPalanquees = bilanData.length;
      const totalPlongeurs = bilanData.reduce((sum, p) => sum + p.plongeurs.length, 0);
      const totalSessions = new Set(bilanData.map(p => `${p.date}_${p.dp}_${p.typeSession}`)).size;
      
      const niveaux = {};
      bilanData.forEach(p => {
        p.plongeurs.forEach(plongeur => {
          niveaux[plongeur.niveau] = (niveaux[plongeur.niveau] || 0) + 1;
        });
      });

      statsContainer.innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${totalSessions}</div>
          <div class="stat-label">Sessions</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${totalPalanquees}</div>
          <div class="stat-label">Palanqu√©es</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${totalPlongeurs}</div>
          <div class="stat-label">Plong√©es totales</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${(totalPlongeurs / totalPalanquees).toFixed(1)}</div>
          <div class="stat-label">Plongeurs/Palanqu√©e</div>
        </div>
      `;
    }

    // Afficher le tableau
    function afficherTableau() {
      const tbody = document.getElementById('bilan-tbody');
      tbody.innerHTML = '';

      bilanData.forEach(row => {
        const tr = document.createElement('tr');
        
        const plongeursStr = row.plongeurs.map(p => p.nom).join(', ');
        const niveauxStr = row.plongeurs.map(p => 
          `<span class="niveau-badge">${p.niveau}</span>`
        ).join(' ');

        tr.innerHTML = `
          <td>${new Date(row.date).toLocaleDateString('fr-FR')}</td>
          <td>${row.dp}</td>
          <td>${row.lieu}</td>
          <td>${row.typeSession}</td>
          <td>${row.numeroPalanquee}</td>
          <td>${row.horaire}</td>
          <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${plongeursStr}">${plongeursStr}</td>
          <td>${niveauxStr}</td>
          <td>${row.profPrevue}</td>
          <td>${row.dureePrevue}</td>
          <td>${row.profRealisee}</td>
          <td>${row.dureeRealisee}</td>
          <td style="max-width: 150px;">${row.paliers}</td>
        `;

        tbody.appendChild(tr);
      });
    }

    // Exporter en CSV
    function exporterCSV() {
      let csv = 'Date;DP;Lieu;Session;Palanqu√©e;Horaire;Plongeurs;Niveaux;Prof. Pr√©vue;Dur√©e Pr√©vue;Prof. R√©alis√©e;Dur√©e R√©alis√©e;Paliers\n';

      bilanData.forEach(row => {
        const plongeurs = row.plongeurs.map(p => p.nom).join(' | ');
        const niveaux = row.plongeurs.map(p => p.niveau).join(' | ');

        csv += `${row.date};${row.dp};${row.lieu};${row.typeSession};${row.numeroPalanquee};${row.horaire};"${plongeurs}";"${niveaux}";${row.profPrevue};${row.dureePrevue};${row.profRealisee};${row.dureeRealisee};"${row.paliers}"\n`;
      });

      telechargerFichier(csv, 'bilan-palanquees.csv', 'text/csv');
    }

    // Exporter en Excel (format HTML)
    function exporterExcel() {
      let html = '<table border="1">';
      html += '<tr><th>Date</th><th>DP</th><th>Lieu</th><th>Session</th><th>Palanqu√©e</th><th>Horaire</th><th>Plongeurs</th><th>Niveaux</th><th>Prof. Pr√©vue</th><th>Dur√©e Pr√©vue</th><th>Prof. R√©alis√©e</th><th>Dur√©e R√©alis√©e</th><th>Paliers</th></tr>';

      bilanData.forEach(row => {
        const plongeurs = row.plongeurs.map(p => p.nom).join(', ');
        const niveaux = row.plongeurs.map(p => p.niveau).join(', ');

        html += `<tr>
          <td>${row.date}</td>
          <td>${row.dp}</td>
          <td>${row.lieu}</td>
          <td>${row.typeSession}</td>
          <td>${row.numeroPalanquee}</td>
          <td>${row.horaire}</td>
          <td>${plongeurs}</td>
          <td>${niveaux}</td>
          <td>${row.profPrevue}</td>
          <td>${row.dureePrevue}</td>
          <td>${row.profRealisee}</td>
          <td>${row.dureeRealisee}</td>
          <td>${row.paliers}</td>
        </tr>`;
      });

      html += '</table>';

      const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'bilan-palanquees.xls';
      a.click();
      URL.revokeObjectURL(url);
    }

    // T√©l√©charger un fichier
    function telechargerFichier(contenu, nomFichier, type) {
      const blob = new Blob([contenu], { type: type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = nomFichier;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Utilitaires d'affichage
    function afficherLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    function afficherAucuneDonnee() {
      document.getElementById('results').style.display = 'none';
      document.getElementById('no-data').style.display = 'block';
      afficherLoading(false);
    }

    function afficherErreur(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      afficherLoading(false);
    }

    function cacherErreur() {
      document.getElementById('error').style.display = 'none';
    }

    function reinitialiserFiltres() {
      const aujourdhui = new Date();
      const ilYaUnMois = new Date();
      ilYaUnMois.setMonth(ilYaUnMois.getMonth() - 1);
      
      document.getElementById('date-debut').valueAsDate = ilYaUnMois;
      document.getElementById('date-fin').valueAsDate = aujourdhui;
      document.getElementById('filtre-dp').value = '';
      document.getElementById('filtre-lieu').value = '';
      
      document.getElementById('results').style.display = 'none';
      document.getElementById('no-data').style.display = 'none';
    }
  </script>
</body>
</html>