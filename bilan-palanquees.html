<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bilan Global Palanqu√©es - JSAS</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  
  <style>
    :root {
      --primary-blue: #007bff;
      --success-green: #28a745;
      --danger-red: #dc3545;
      --dark-blue: #003366;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #f7fcff; color: #333; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .header { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid var(--primary-blue); }
    .logo { height: 60px; width: auto; }
    h1 { color: var(--dark-blue); font-size: 28px; }
    .filters { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
    .filter-row { display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 15px; }
    .filter-group { flex: 1; min-width: 200px; }
    .filter-group label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--dark-blue); }
    .filter-group input, .filter-group select { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; }
    .filter-group input:focus, .filter-group select:focus { outline: none; border-color: var(--primary-blue); }
    .btn { padding: 12px 24px; border: none; border-radius: 5px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
    .btn-primary { background: var(--primary-blue); color: white; }
    .btn-primary:hover { background: #0056b3; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,123,255,0.3); }
    .btn-success { background: var(--success-green); color: white; }
    .btn-success:hover { background: #1e7e34; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #545b62; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .stat-card { background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 2px solid var(--primary-blue); border-radius: 8px; padding: 20px; text-align: center; }
    .stat-value { font-size: 32px; font-weight: bold; color: var(--dark-blue); }
    .stat-label { font-size: 14px; color: #666; margin-top: 5px; }
    .loading { text-align: center; padding: 40px; color: #666; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .table-container { overflow-x: auto; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background: var(--dark-blue); color: white; padding: 12px 8px; text-align: left; font-weight: bold; position: sticky; top: 0; z-index: 10; }
    td { padding: 10px 8px; border-bottom: 1px solid #ddd; }
    tr:hover { background: #f8f9fa; }
    tr:nth-child(even) { background: #fafafa; }
    .niveau-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; color: white; background: var(--success-green); }
    .alert { padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .export-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .back-link { display: inline-block; margin-bottom: 20px; color: var(--primary-blue); text-decoration: none; font-weight: bold; }
    .back-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" class="back-link">‚Üê Retour √† l'application</a>

    <div class="header">
      <img src="images/logo-jsas.png" alt="Logo JSAS" class="logo">
      <div>
        <h1>Bilan Global des Palanqu√©es</h1>
        <p style="color: #666; margin-top: 5px;">Analyse consolid√©e des sessions de plong√©e</p>
      </div>
    </div>

    <div class="filters">
      <div class="filter-row">
        <div class="filter-group">
          <label for="date-debut">Date de d√©but</label>
          <input type="date" id="date-debut">
        </div>
        <div class="filter-group">
          <label for="date-fin">Date de fin</label>
          <input type="date" id="date-fin">
        </div>
        <div class="filter-group">
          <label for="filtre-dp">Directeur de Plong√©e</label>
          <select id="filtre-dp"><option value="">Tous les DP</option></select>
        </div>
        <div class="filter-group">
          <label for="filtre-lieu">Lieu</label>
          <select id="filtre-lieu"><option value="">Tous les lieux</option></select>
        </div>
      </div>
      <div class="filter-row">
        <button class="btn btn-primary" onclick="chargerBilan()">G√©n√©rer le bilan</button>
        <button class="btn btn-secondary" onclick="reinitialiserFiltres()">R√©initialiser</button>
      </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>Chargement des donn√©es...</p>
    </div>

    <div id="results" style="display: none;">
      <div class="stats" id="stats-container"></div>
      <div class="export-buttons">
        <button class="btn btn-success" onclick="exporterCSV()">üìä Exporter CSV</button>
        <button class="btn btn-success" onclick="exporterExcel()">üìó Exporter Excel</button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>DP</th><th>Lieu</th><th>Session</th><th>Palanqu√©e</th><th>Horaire</th><th>Plongeurs</th><th>Niveaux</th><th>Prof. Pr√©vue</th><th>Dur√©e Pr√©vue</th><th>Prof. R√©alis√©e</th><th>Dur√©e R√©alis√©e</th><th>Paliers</th>
            </tr>
          </thead>
          <tbody id="bilan-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="no-data" class="alert alert-info" style="display: none;">Aucune donn√©e disponible pour la p√©riode s√©lectionn√©e.</div>
    <div id="error" class="alert alert-danger" style="display: none;"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA9FO6BiHkm7dOQ3Z4-wpPQRgnsGKg3pmM",
      authDomain: "palanquees-jsas.firebaseapp.com",
      databaseURL: "https://palanquees-jsas-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "palanquees-jsas",
      storageBucket: "palanquees-jsas.firebasestorage.app",
      messagingSenderId: "284449736616",
      appId: "1:284449736616:web:a0949a9b669def06323f9d"
    };

    let app, db;
    let bilanData = [];
    
    // Ordre hi√©rarchique des niveaux (global)
    const ORDRE_NIVEAUX = ['E4', 'E3', 'E2', 'N4/GP', 'GP', 'N4', 'N3', 'N2', 'N1', 'Plg.Or', 'Plg.Ar', 'Plg.Br', 'D√©b.', 'd√©butant', 'D√©b'];
    
    // Fonction pour trier les plongeurs par niveau puis par nom
    function trierPlongeursParNiveau(plongeurs) {
      return [...plongeurs].sort((a, b) => {
        const indexA = ORDRE_NIVEAUX.indexOf(a.niveau);
        const indexB = ORDRE_NIVEAUX.indexOf(b.niveau);
        const posA = indexA === -1 ? 999 : indexA;
        const posB = indexB === -1 ? 999 : indexB;
        
        // Si m√™me niveau, trier par nom alphab√©tiquement
        if (posA === posB) {
          return a.nom.localeCompare(b.nom, 'fr', { sensitivity: 'base' });
        }
        
        return posA - posB;
      });
    }
    
    try {
      app = firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      console.log('‚úÖ Firebase initialis√©');
    } catch (error) {
      console.error('‚ùå Erreur init Firebase:', error);
    }

    async function chargerFiltres() {
      if (!db) return;
      try {
        const snapshot = await db.ref('sessions').once('value');
        if (!snapshot.exists()) return;
        const sessions = snapshot.val();
        const dps = new Set();
        const lieux = new Set();
        
        // Charger les DPs et lieux depuis les sessions
        Object.values(sessions).forEach(session => {
          if (session.meta) {
            if (session.meta.dp) {
              const dpNormalise = session.meta.dp.trim();
              dps.add(dpNormalise);
            }
            if (session.meta.lieu) lieux.add(session.meta.lieu.trim());
          }
        });
        
        // Ajouter tous les DP depuis dp_database
        try {
          const dpDbSnapshot = await db.ref('dp_database').once('value');
          if (dpDbSnapshot.exists()) {
            const dpDatabase = dpDbSnapshot.val();
            Object.values(dpDatabase).forEach(dp => {
              if (dp.nom) {
                dps.add(dp.nom.trim());
              }
            });
          }
        } catch (e) {
          console.log('Erreur chargement dp_database:', e);
        }
        
        console.log('DPs trouv√©s:', Array.from(dps).length, 'Lieux:', Array.from(lieux).length);
        const dpSelect = document.getElementById('filtre-dp');
        Array.from(dps).sort().forEach(dp => {
          const option = document.createElement('option');
          option.value = dp;
          option.textContent = dp;
          dpSelect.appendChild(option);
        });
        const lieuSelect = document.getElementById('filtre-lieu');
        Array.from(lieux).sort().forEach(lieu => {
          const option = document.createElement('option');
          option.value = lieu;
          option.textContent = lieu;
          lieuSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Erreur filtres:', error);
      }
    }

    async function chargerBilan() {
      const dateDebut = document.getElementById('date-debut').value;
      const dateFin = document.getElementById('date-fin').value;
      const filtreDP = document.getElementById('filtre-dp').value;
      const filtreLieu = document.getElementById('filtre-lieu').value;
      if (!dateDebut || !dateFin) { afficherErreur('Veuillez s√©lectionner les dates'); return; }
      if (new Date(dateDebut) > new Date(dateFin)) { afficherErreur('Date de d√©but invalide'); return; }
      afficherLoading(true);
      cacherErreur();
      try {
        const snapshot = await db.ref('sessions').once('value');
        if (!snapshot.exists()) { afficherAucuneDonnee(); return; }
        const sessions = snapshot.val();
        bilanData = [];
        Object.entries(sessions).forEach(([key, session]) => {
          if (!session.meta || !session.palanquees) return;
          const sessionDate = session.meta.date;
          if (sessionDate < dateDebut || sessionDate > dateFin) return;
          if (filtreDP && session.meta.dp !== filtreDP) return;
          if (filtreLieu && session.meta.lieu !== filtreLieu) return;
          session.palanquees.forEach((palanquee, idx) => {
            if (!palanquee || !palanquee.plongeurs) return;
            
            // Trier les plongeurs par niveau puis par nom avant de les stocker
            const plongeursTries = trierPlongeursParNiveau(palanquee.plongeurs);
            
            bilanData.push({
              date: session.meta.date, dp: session.meta.dp, lieu: session.meta.lieu,
              typeSession: session.meta.plongee || 'matin', numeroPalanquee: idx + 1,
              horaire: palanquee.parametres?.horaire || '', 
              plongeurs: plongeursTries,
              guide: palanquee.parametres?.guide || '',
              directeur: palanquee.parametres?.directeur || '',
              profPrevue: palanquee.parametres?.profondeurPrevue || '',
              dureePrevue: palanquee.parametres?.dureePrevue || '',
              profRealisee: palanquee.parametres?.profondeurRealisee || '',
              dureeRealisee: palanquee.parametres?.dureeRealisee || '',
              paliers: palanquee.parametres?.paliers || ''
            });
          });
        });
        if (bilanData.length === 0) { afficherAucuneDonnee(); return; }
        
        // Trier les donn√©es par date, puis par lieu, puis par type de session
        const ordreSession = ['matin', 'apr√®s-midi', 'soir', 'nuit', 'plg1', 'plg2', 'plg3', 'plg4', 'Formation', 'autre'];
        bilanData.sort((a, b) => {
          // D'abord par date
          if (a.date !== b.date) {
            return a.date.localeCompare(b.date);
          }
          // Ensuite par lieu (site)
          if (a.lieu !== b.lieu) {
            return a.lieu.localeCompare(b.lieu, 'fr', { sensitivity: 'base' });
          }
          // Puis par type de session
          const indexA = ordreSession.indexOf(a.typeSession);
          const indexB = ordreSession.indexOf(b.typeSession);
          const posA = indexA === -1 ? 999 : indexA;
          const posB = indexB === -1 ? 999 : indexB;
          if (posA !== posB) {
            return posA - posB;
          }
          // Enfin par num√©ro de palanqu√©e
          return a.numeroPalanquee - b.numeroPalanquee;
        });
        
        afficherStatistiques();
        afficherTableau();
        document.getElementById('results').style.display = 'block';
        document.getElementById('no-data').style.display = 'none';
      } catch (error) {
        afficherErreur('Erreur: ' + error.message);
      } finally {
        afficherLoading(false);
      }
    }

    function afficherStatistiques() {
      const statsContainer = document.getElementById('stats-container');
      const totalPalanquees = bilanData.length;
      const totalPlongeurs = bilanData.reduce((sum, p) => sum + p.plongeurs.length, 0);
      const totalSessions = new Set(bilanData.map(p => `${p.date}_${p.dp}_${p.typeSession}`)).size;
      
      // Compter les plongeurs par niveau
      const niveaux = {};
      bilanData.forEach(p => {
        p.plongeurs.forEach(plongeur => {
          niveaux[plongeur.niveau] = (niveaux[plongeur.niveau] || 0) + 1;
        });
      });
      
      // Trier les niveaux par ordre hi√©rarchique
      const niveauxTries = Object.entries(niveaux).sort((a, b) => {
        const indexA = ORDRE_NIVEAUX.indexOf(a[0]);
        const indexB = ORDRE_NIVEAUX.indexOf(b[0]);
        return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
      });
      
      statsContainer.innerHTML = `
        <div class="stat-card"><div class="stat-value">${totalSessions}</div><div class="stat-label">Sessions</div></div>
        <div class="stat-card"><div class="stat-value">${totalPalanquees}</div><div class="stat-label">Palanqu√©es</div></div>
        <div class="stat-card"><div class="stat-value">${totalPlongeurs}</div><div class="stat-label">Plong√©es totales</div></div>
        <div class="stat-card"><div class="stat-value">${(totalPlongeurs / totalPalanquees).toFixed(1)}</div><div class="stat-label">Plongeurs/Palanqu√©e</div></div>
      `;
      
      // Ajouter le tableau des niveaux
      if (niveauxTries.length > 0) {
        const niveauxHTML = `
          <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid var(--primary-blue);">
            <h3 style="color: var(--dark-blue); margin-bottom: 15px;">üìä R√©partition par niveau</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: var(--dark-blue); color: white;">
                  <th style="padding: 10px; text-align: left;">Niveau</th>
                  <th style="padding: 10px; text-align: right;">Nombre de plong√©es</th>
                  <th style="padding: 10px; text-align: right;">Pourcentage</th>
                </tr>
              </thead>
              <tbody>
                ${niveauxTries.map(([niveau, count]) => `
                  <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 8px;"><span class="niveau-badge">${niveau}</span></td>
                    <td style="padding: 8px; text-align: right; font-weight: bold;">${count}</td>
                    <td style="padding: 8px; text-align: right;">${((count / totalPlongeurs) * 100).toFixed(1)}%</td>
                  </tr>
                `).join('')}
                <tr style="background: #e3f2fd; font-weight: bold;">
                  <td style="padding: 10px;">TOTAL</td>
                  <td style="padding: 10px; text-align: right;">${totalPlongeurs}</td>
                  <td style="padding: 10px; text-align: right;">100%</td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
        statsContainer.insertAdjacentHTML('afterend', niveauxHTML);
      }
    }

    function afficherTableau() {
      const tbody = document.getElementById('bilan-tbody');
      tbody.innerHTML = '';
      
      let sessionPrecedente = null;
      let palanqueePrecedente = null;
      
      bilanData.forEach(row => {
        const sessionActuelle = `${row.date}_${row.dp}_${row.typeSession}`;
        const palanqueeActuelle = `${sessionActuelle}_${row.numeroPalanquee}`;
        
        // Ajouter une ligne de s√©paration orange si changement de session
        if (sessionPrecedente !== null && sessionPrecedente !== sessionActuelle) {
          const separateur = document.createElement('tr');
          separateur.innerHTML = `
            <td colspan="14" style="background: #FF6B00; height: 10px; padding: 0; border: none;"></td>
          `;
          tbody.appendChild(separateur);
        }
        // Ajouter une ligne de s√©paration grise si changement de palanqu√©e (mais pas de session)
        else if (palanqueePrecedente !== null && palanqueePrecedente !== palanqueeActuelle) {
          const separateur = document.createElement('tr');
          separateur.innerHTML = `
            <td colspan="14" style="background: #999; height: 3px; padding: 0; border: none;"></td>
          `;
          tbody.appendChild(separateur);
        }
        
        // Afficher un plongeur par ligne
        row.plongeurs.forEach((plongeur, index) => {
          const tr = document.createElement('tr');
          
          // D√©terminer la pr√©rogative depuis le champ 'pre' du plongeur
          let prerogative = '';
          if (plongeur.pre) {
            if (plongeur.pre === 'DP') {
              prerogative = 'Directeur de plong√©e';
            } else if (plongeur.pre === 'GP') {
              prerogative = 'Guide de palanqu√©e';
            } else {
              prerogative = plongeur.pre;
            }
          }
          
          tr.innerHTML = `
            <td>${index === 0 ? new Date(row.date).toLocaleDateString('fr-FR') : ''}</td>
            <td>${index === 0 ? row.dp : ''}</td>
            <td>${index === 0 ? row.lieu : ''}</td>
            <td>${index === 0 ? row.typeSession : ''}</td>
            <td>${index === 0 ? row.numeroPalanquee : ''}</td>
            <td>${plongeur.nom}</td>
            <td>${prerogative}</td>
            <td><span class="niveau-badge">${plongeur.niveau}</span></td>
            <td>${index === 0 ? row.horaire : ''}</td>
            <td>${index === 0 ? row.profPrevue : ''}</td>
            <td>${index === 0 ? row.dureePrevue : ''}</td>
            <td>${index === 0 ? row.profRealisee : ''}</td>
            <td>${index === 0 ? row.dureeRealisee : ''}</td>
            <td>${index === 0 ? row.paliers : ''}</td>
          `;
          tbody.appendChild(tr);
        });
        
        sessionPrecedente = sessionActuelle;
        palanqueePrecedente = palanqueeActuelle;
      });
    }

    function exporterCSV() {
      let csv = 'Date;DP;Lieu;Session;Palanqu√©e;Plongeur;Pr√©rogative;Niveau;Horaire;Prof. Pr√©vue (m);Dur√©e Pr√©vue (min);Prof. R√©alis√©e (m);Dur√©e R√©alis√©e (min);Paliers\n';
      
      bilanData.forEach(row => {
        row.plongeurs.forEach((plongeur, index) => {
          let prerogative = '';
          if (plongeur.pre) {
            if (plongeur.pre === 'DP') {
              prerogative = 'Directeur de plong√©e';
            } else if (plongeur.pre === 'GP') {
              prerogative = 'Guide de palanqu√©e';
            } else {
              prerogative = plongeur.pre;
            }
          }
          
          csv += `${index === 0 ? row.date : ''};${index === 0 ? row.dp : ''};${index === 0 ? row.lieu : ''};${index === 0 ? row.typeSession : ''};${index === 0 ? row.numeroPalanquee : ''};${plongeur.nom};${prerogative};${plongeur.niveau};${index === 0 ? row.horaire : ''};${index === 0 ? row.profPrevue : ''};${index === 0 ? row.dureePrevue : ''};${index === 0 ? row.profRealisee : ''};${index === 0 ? row.dureeRealisee : ''};${index === 0 ? row.paliers : ''}\n`;
        });
      });
      
      // Ajouter les statistiques par niveau
      csv += '\n\nSTATISTIQUES PAR NIVEAU\n';
      csv += 'Niveau;Nombre de plong√©es;Pourcentage\n';
      const niveaux = {};
      const totalPlongeurs = bilanData.reduce((sum, p) => sum + p.plongeurs.length, 0);
      bilanData.forEach(p => {
        p.plongeurs.forEach(plongeur => {
          niveaux[plongeur.niveau] = (niveaux[plongeur.niveau] || 0) + 1;
        });
      });
      const niveauxTries = Object.entries(niveaux).sort((a, b) => {
        const indexA = ORDRE_NIVEAUX.indexOf(a[0]);
        const indexB = ORDRE_NIVEAUX.indexOf(b[0]);
        return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
      });
      niveauxTries.forEach(([niveau, count]) => {
        csv += `${niveau};${count};${((count / totalPlongeurs) * 100).toFixed(1)}%\n`;
      });
      csv += `TOTAL;${totalPlongeurs};100%\n`;
      
      // UTF-8 BOM pour assurer la compatibilit√© des accents avec Excel
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'bilan-palanquees.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function exporterExcel() {
      let html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial, sans-serif; background-color: #f5f5f5; }
    h2 { background-color: #FF6B00; color: white; padding: 20px; margin: 0 0 30px 0; text-align: center; font-size: 24px; border: 3px solid #000; }
    table { border-collapse: collapse; width: 100%; background: white; }
    th { background-color: #FF6B00; color: white; padding: 12px; border: 3px solid #000; font-weight: bold; text-align: left; font-size: 14px; }
    td { padding: 8px; border: 1px solid #666; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    .stats-header { background-color: #007bff; color: white; padding: 10px; margin-top: 20px; }
    .total-row { background-color: #e3f2fd; font-weight: bold; }
    .session-separator { background: #FF6B00; height: 10px; }
    .palanquee-separator { background: #999; height: 3px; }
  </style>
</head>
<body>`;
      
      html += '<table><tr><th>Date</th><th>DP</th><th>Lieu</th><th>Session</th><th>Palanqu√©e</th><th>Plongeur</th><th>Pr√©rogative</th><th>Niveau</th><th>Horaire</th><th>Prof. Pr√©vue (m)</th><th>Dur√©e Pr√©vue (min)</th><th>Prof. R√©alis√©e (m)</th><th>Dur√©e R√©alis√©e (min)</th><th>Paliers</th></tr>';
      
      let sessionPrecedente = null;
      let palanqueePrecedente = null;
      
      bilanData.forEach(row => {
        const sessionActuelle = `${row.date}_${row.dp}_${row.typeSession}`;
        const palanqueeActuelle = `${sessionActuelle}_${row.numeroPalanquee}`;
        
        // Ajouter un s√©parateur orange si changement de session
        if (sessionPrecedente !== null && sessionPrecedente !== sessionActuelle) {
          html += `<tr><td colspan="14" class="session-separator"></td></tr>`;
        }
        // Ajouter un s√©parateur gris si changement de palanqu√©e (mais pas de session)
        else if (palanqueePrecedente !== null && palanqueePrecedente !== palanqueeActuelle) {
          html += `<tr><td colspan="14" class="palanquee-separator"></td></tr>`;
        }
        
        // Afficher un plongeur par ligne
        row.plongeurs.forEach((plongeur, index) => {
          // D√©terminer la pr√©rogative depuis le champ 'pre' du plongeur
          let prerogative = '';
          if (plongeur.pre) {
            if (plongeur.pre === 'DP') {
              prerogative = 'Directeur de plong√©e';
            } else if (plongeur.pre === 'GP') {
              prerogative = 'Guide de palanqu√©e';
            } else {
              prerogative = plongeur.pre;
            }
          }
          
          html += `<tr>
            <td>${index === 0 ? row.date : ''}</td>
            <td>${index === 0 ? row.dp : ''}</td>
            <td>${index === 0 ? row.lieu : ''}</td>
            <td>${index === 0 ? row.typeSession : ''}</td>
            <td>${index === 0 ? row.numeroPalanquee : ''}</td>
            <td>${plongeur.nom}</td>
            <td>${prerogative}</td>
            <td>${plongeur.niveau}</td>
            <td>${index === 0 ? row.horaire : ''}</td>
            <td>${index === 0 ? row.profPrevue : ''}</td>
            <td>${index === 0 ? row.dureePrevue : ''}</td>
            <td>${index === 0 ? row.profRealisee : ''}</td>
            <td>${index === 0 ? row.dureeRealisee : ''}</td>
            <td>${index === 0 ? row.paliers : ''}</td>
          </tr>`;
        });
        
        sessionPrecedente = sessionActuelle;
        palanqueePrecedente = palanqueeActuelle;
      });
      html += '</table>';
      
      // Statistiques par niveau
      html += '<br><br><h3 class="stats-header">STATISTIQUES PAR NIVEAU</h3>';
      html += '<table style="width: 50%;"><tr><th>Niveau</th><th>Nombre de plong√©es</th><th>Pourcentage</th></tr>';
      
      const niveaux = {};
      const totalPlongeurs = bilanData.reduce((sum, p) => sum + p.plongeurs.length, 0);
      bilanData.forEach(p => {
        p.plongeurs.forEach(plongeur => {
          niveaux[plongeur.niveau] = (niveaux[plongeur.niveau] || 0) + 1;
        });
      });
      
      const niveauxTries = Object.entries(niveaux).sort((a, b) => {
        const indexA = ORDRE_NIVEAUX.indexOf(a[0]);
        const indexB = ORDRE_NIVEAUX.indexOf(b[0]);
        return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
      });
      
      niveauxTries.forEach(([niveau, count]) => {
        html += `<tr><td>${niveau}</td><td>${count}</td><td>${((count / totalPlongeurs) * 100).toFixed(1)}%</td></tr>`;
      });
      html += `<tr class="total-row"><td>TOTAL</td><td>${totalPlongeurs}</td><td>100%</td></tr>`;
      html += '</table></body></html>';
      
      // UTF-8 BOM pour garantir les accents dans Excel
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + html], { type: 'application/vnd.ms-excel;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'bilan-palanquees.xls';
      a.click();
      URL.revokeObjectURL(url);
    }

    function afficherLoading(show) { document.getElementById('loading').style.display = show ? 'block' : 'none'; }
    function afficherAucuneDonnee() {
      document.getElementById('results').style.display = 'none';
      document.getElementById('no-data').style.display = 'block';
      afficherLoading(false);
    }
    function afficherErreur(message) {
      document.getElementById('error').textContent = message;
      document.getElementById('error').style.display = 'block';
      afficherLoading(false);
    }
    function cacherErreur() { document.getElementById('error').style.display = 'none'; }
    function reinitialiserFiltres() {
      const aujourdhui = new Date();
      const ilYaUnMois = new Date();
      ilYaUnMois.setMonth(ilYaUnMois.getMonth() - 1);
      document.getElementById('date-debut').valueAsDate = ilYaUnMois;
      document.getElementById('date-fin').valueAsDate = aujourdhui;
      document.getElementById('filtre-dp').value = '';
      document.getElementById('filtre-lieu').value = '';
      document.getElementById('results').style.display = 'none';
      document.getElementById('no-data').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', async function() {
      try {
        if (!db) { afficherErreur('Firebase non disponible'); return; }
        const aujourdhui = new Date();
        const ilYaUnMois = new Date();
        ilYaUnMois.setMonth(ilYaUnMois.getMonth() - 1);
        document.getElementById('date-fin').valueAsDate = aujourdhui;
        document.getElementById('date-debut').valueAsDate = ilYaUnMois;
        await chargerFiltres();
      } catch (error) {
        afficherErreur('Erreur: ' + error.message);
      }
    });
  </script>
</body>
</html>