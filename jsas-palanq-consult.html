<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSA - Consultation des Palanqu√©es</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <!-- Librairies pour PDF et QR Code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      text-align: center;
    }
    
    .header h1 {
      color: #6f42c1;
      margin-bottom: 10px;
    }
    
    .header .mode-badge {
      display: inline-block;
      background: #28a745;
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
    }
    
    .view-toggle {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }
    
    .view-btn {
      padding: 10px 20px;
      border: 2px solid #6f42c1;
      background: white;
      color: #6f42c1;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
    }
    
    .view-btn.active {
      background: #6f42c1;
      color: white;
    }
    
    .search-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .search-box {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .search-box input, .search-box select {
      flex: 1;
      min-width: 200px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .search-box input:focus, .search-box select:focus {
      outline: none;
      border-color: #6f42c1;
    }
    
    .btn-search {
      background: #6f42c1;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
    }
    
    .btn-search:hover {
      background: #5a32a3;
    }
    
    .export-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .btn-export {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .btn-pdf {
      background: #dc3545;
      color: white;
    }
    
    .btn-pdf:hover {
      background: #c82333;
    }
    
    /* Vue Calendrier */
    .calendar-view {
      display: none;
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .calendar-nav {
      display: flex;
      gap: 10px;
    }
    
    .calendar-btn {
      padding: 8px 15px;
      background: #6f42c1;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .calendar-btn:hover {
      background: #5a32a3;
    }
    
    .calendar-month {
      font-size: 1.5em;
      color: #333;
      font-weight: bold;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #ddd;
      border: 1px solid #ddd;
    }
    
    .calendar-day-header {
      background: #f8f9fa;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      color: #666;
    }
    
    .calendar-day {
      background: white;
      min-height: 80px;
      padding: 8px;
      cursor: pointer;
      transition: background 0.3s;
      position: relative;
    }
    
    .calendar-day:hover {
      background: #f0f0f0;
    }
    
    .calendar-day-number {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .calendar-day-sessions {
      font-size: 0.8em;
    }
    
    .calendar-session-badge {
      display: inline-block;
      background: #6f42c1;
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      margin: 2px;
      font-size: 0.75em;
    }
    
    .calendar-day.has-sessions {
      background: #e3f2fd;
    }
    
    .calendar-day.selected {
      background: #6f42c1;
      color: white;
    }
    
    .calendar-day.selected .calendar-session-badge {
      background: white;
      color: #6f42c1;
    }
    
    /* Vue Liste */
    .palanquees-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .palanquee-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      position: relative;
    }
    
    .palanquee-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    .qr-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #007bff;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.8em;
    }
    
    .qr-button:hover {
      background: #0056b3;
    }
    
    .session-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: -20px -20px 20px -20px;
      text-align: center;
    }
    
    .session-date {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .session-info {
      display: flex;
      justify-content: center;
      gap: 20px;
      font-size: 0.9em;
      opacity: 0.95;
    }
    
    .palanquee-title {
      font-size: 1.1em;
      color: #333;
      font-weight: bold;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .palanquee-details {
      display: grid;
      gap: 8px;
      margin-bottom: 15px;
      font-size: 0.95em;
    }
    
    .detail-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .detail-icon {
      width: 20px;
      text-align: center;
    }
    
    .detail-label {
      font-weight: 600;
      color: #666;
      min-width: 100px;
    }
    
    .detail-value {
      color: #333;
    }
    
    .paliers-info {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 5px;
      padding: 8px;
      margin-top: 10px;
      font-size: 0.9em;
      color: #856404;
    }
    
    .plongeurs-list {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-top: 15px;
    }
    
    .plongeurs-title {
      font-size: 0.9em;
      font-weight: bold;
      color: #666;
      margin-bottom: 10px;
    }
    
    .plongeur-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin: 5px 0;
      background: white;
      border-radius: 5px;
      border-left: 4px solid #6f42c1;
    }
    
    .plongeur-rank {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.8em;
      margin-right: 8px;
      font-weight: bold;
      color: #666;
    }
    
    .plongeur-name {
      font-weight: 500;
      color: #333;
      flex: 1;
    }
    
    .plongeur-badges {
      display: flex;
      gap: 5px;
    }
    
    .niveau-badge {
      background: #6f42c1;
      color: white;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.85em;
      font-weight: bold;
    }
    
    .pre-badge {
      background: #17a2b8;
      color: white;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.85em;
    }
    
    .no-results {
      background: white;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      color: #999;
    }
    
    .stats-banner {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      text-align: center;
    }
    
    .stat-item {
      padding: 10px;
    }
    
    .stat-value {
      font-size: 2em;
      color: #6f42c1;
      font-weight: bold;
    }
    
    .stat-label {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
    }
    
    .filter-chips {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }
    
    .chip {
      background: #e0e0e0;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .chip.active {
      background: #6f42c1;
      color: white;
    }
    
    .chip:hover {
      background: #d0d0d0;
    }
    
    .chip.active:hover {
      background: #5a32a3;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
    }
    
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Modal QR Code */
    .qr-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .qr-modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      max-width: 400px;
    }
    
    .qr-modal-title {
      font-size: 1.2em;
      margin-bottom: 20px;
      color: #333;
    }
    
    .qr-modal-close {
      margin-top: 20px;
      padding: 10px 20px;
      background: #6f42c1;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    @media (max-width: 768px) {
      .search-box {
        flex-direction: column;
      }
      
      .search-box input, .search-box select {
        width: 100%;
      }
      
      .palanquees-grid {
        grid-template-columns: 1fr;
      }
      
      .calendar-grid {
        font-size: 0.8em;
      }
      
      .calendar-day {
        min-height: 60px;
        padding: 5px;
      }
    }
    
    .footer {
      text-align: center;
      color: white;
      margin-top: 40px;
      padding: 20px;
    }
    
    .refresh-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #28a745;
      color: white;
      border: none;
      padding: 15px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      font-size: 1.5em;
      transition: transform 0.3s;
      z-index: 100;
    }
    
    .refresh-btn:hover {
      transform: rotate(180deg);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- En-t√™te -->
    <div class="header">
      <h1>ü§ø JSA Subaquatique - Palanqu√©es</h1>
      <div class="mode-badge">üëÅÔ∏è Mode Consultation</div>
      <p style="margin-top: 10px; color: #666;">Consultez les palanqu√©es et trouvez vos sessions de plong√©e</p>
      
      <!-- Boutons de vue -->
      <div class="view-toggle">
        <button class="view-btn active" onclick="switchView('list')">üìã Liste</button>
        <button class="view-btn" onclick="switchView('calendar')">üìÖ Calendrier</button>
      </div>
    </div>
    
    <!-- Statistiques -->
    <div class="stats-banner" id="stats">
      <div class="stat-item">
        <div class="stat-value" id="stat-total">0</div>
        <div class="stat-label">Sessions totales</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-today">0</div>
        <div class="stat-label">Aujourd'hui</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-week">0</div>
        <div class="stat-label">Cette semaine</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-plongeurs">0</div>
        <div class="stat-label">Plongeurs actifs</div>
      </div>
    </div>
    
    <!-- Section recherche -->
    <div class="search-section">
      <h2 style="margin-bottom: 15px; color: #333;">üîç Rechercher une palanqu√©e</h2>
      
      <div class="search-box">
        <input type="text" id="search-name" placeholder="Votre nom..." />
        <input type="date" id="search-date" />
        <select id="search-lieu">
          <option value="">Tous les lieux</option>
        </select>
        <button class="btn-search" onclick="searchPalanquees()">
          üîç Rechercher
        </button>
      </div>
      
      <!-- Filtres rapides -->
      <div class="filter-chips">
        <div class="chip" onclick="filterToday(this)">üìÖ Aujourd'hui</div>
        <div class="chip" onclick="filterWeek(this)">üìÜ Cette semaine</div>
        <div class="chip" onclick="filterMonth(this)">üìä Ce mois</div>
        <div class="chip" onclick="filterMyPalanquees(this)">üë§ Mes palanqu√©es</div>
        <div class="chip active" onclick="showAll(this)">üìã Tout afficher</div>
      </div>
      
      <!-- Boutons d'export -->
      <div class="export-buttons">
        <button class="btn-export btn-pdf" onclick="exportPDF()">üìÑ Exporter en PDF</button>
      </div>
    </div>
    
    <!-- Chargement -->
    <div id="loading" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>Chargement des donn√©es...</p>
    </div>
    
    <!-- Vue Calendrier -->
    <div class="calendar-view" id="calendar-view">
      <div class="calendar-header">
        <div class="calendar-nav">
          <button class="calendar-btn" onclick="previousMonth()">‚óÄ</button>
          <button class="calendar-btn" onclick="currentMonth()">Aujourd'hui</button>
          <button class="calendar-btn" onclick="nextMonth()">‚ñ∂</button>
        </div>
        <div class="calendar-month" id="calendar-month"></div>
      </div>
      <div class="calendar-grid" id="calendar-grid"></div>
    </div>
    
    <!-- Vue Liste -->
    <div class="palanquees-grid" id="palanquees-container">
      <!-- Les palanqu√©es seront affich√©es ici -->
    </div>
    
    <!-- Message si pas de r√©sultats -->
    <div class="no-results" id="no-results" style="display: none;">
      <h3>üîç Aucune palanqu√©e trouv√©e</h3>
      <p>Modifiez vos crit√®res de recherche ou consultez toutes les palanqu√©es</p>
    </div>
  </div>
  
  <!-- Modal QR Code -->
  <div class="qr-modal" id="qr-modal">
    <div class="qr-modal-content">
      <h3 class="qr-modal-title">QR Code de la session</h3>
      <div id="qr-code"></div>
      <button class="qr-modal-close" onclick="closeQRModal()">Fermer</button>
    </div>
  </div>
  
  <!-- Bouton rafra√Æchir -->
  <button class="refresh-btn" onclick="refreshData()" title="Rafra√Æchir les donn√©es">
    üîÑ
  </button>
  
  <!-- Footer -->
  <div class="footer">
    <p>Version consultation publique - Lecture seule</p>
    <p style="font-size: 0.9em; opacity: 0.8;">JSA Subaquatique ¬© 2025</p>
  </div>

  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA9FO6BiHkm7dOQ3Z4-wpPQRgnsGKg3pmM",
      authDomain: "palanquees-jsas.firebaseapp.com",
      databaseURL: "https://palanquees-jsas-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "palanquees-jsas",
      storageBucket: "palanquees-jsas.firebasestorage.app",
      messagingSenderId: "284449736616",
      appId: "1:284449736616:web:a0949a9b669def06323f9d"
    };

    let app, db;
    let allSessions = [];
    let filteredSessions = [];
    let currentView = 'list';
    let currentDate = new Date();
    
    // Ordre des niveaux pour le tri
    const ORDRE_NIVEAUX = ['E4', 'E3', 'E2', 'N4/GP', 'GP', 'N4', 'N3', 'N2', 'N1', 'Plg.Or', 'Plg.Ar', 'Plg.Br', 'D√©b.', 'd√©butant', 'D√©b'];
    
    // Initialisation Firebase
    try {
      app = firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      console.log('‚úÖ Firebase initialis√©');
    } catch (error) {
      console.error('‚ùå Erreur Firebase:', error);
    }
    
    // Fonction de tri des plongeurs
    function trierPlongeursParNiveau(plongeurs) {
      return [...plongeurs].sort((a, b) => {
        const indexA = ORDRE_NIVEAUX.indexOf(a.niveau);
        const indexB = ORDRE_NIVEAUX.indexOf(b.niveau);
        const posA = indexA === -1 ? 999 : indexA;
        const posB = indexB === -1 ? 999 : indexB;
        
        if (posA === posB) {
          // Si m√™me niveau, trier par nom
          return a.nom.localeCompare(b.nom, 'fr', { sensitivity: 'base' });
        }
        return posA - posB;
      });
    }
    
    // Charger toutes les donn√©es
    async function loadData() {
      if (!db) return;
      
      document.getElementById('loading').style.display = 'block';
      
      try {
        const snapshot = await db.ref('sessions').once('value');
        
        if (!snapshot.exists()) {
          document.getElementById('no-results').style.display = 'block';
          document.getElementById('loading').style.display = 'none';
          return;
        }
        
        const sessions = snapshot.val();
        allSessions = [];
        
        Object.entries(sessions).forEach(([key, session]) => {
          if (!session.meta || !session.palanquees) return;
          
          const sessionData = {
            id: key,
            date: session.meta.date,
            dp: session.meta.dp,
            lieu: session.meta.lieu,
            typeSession: session.meta.plongee || 'matin',
            palanquees: []
          };
          
          session.palanquees.forEach((palanquee, idx) => {
            if (!palanquee || !palanquee.plongeurs) return;
            
            // Trier les plongeurs par niveau puis par nom
            const plongeursTries = trierPlongeursParNiveau(palanquee.plongeurs);
            
            sessionData.palanquees.push({
              numero: idx + 1,
              horaire: palanquee.parametres?.horaire || '',
              profPrevue: palanquee.parametres?.profondeurPrevue || '',
              dureePrevue: palanquee.parametres?.dureePrevue || '',
              profRealisee: palanquee.parametres?.profondeurRealisee || '',
              dureeRealisee: palanquee.parametres?.dureeRealisee || '',
              paliers: palanquee.parametres?.paliers || '',
              plongeurs: plongeursTries
            });
          });
          
          if (sessionData.palanquees.length > 0) {
            allSessions.push(sessionData);
          }
        });
        
        // Trier par date, puis lieu, puis type de session
        allSessions.sort((a, b) => {
          // 1. Trier par date (plus proche en premier)
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          const now = new Date();
          
          // Dates futures d'abord, puis pass√©es
          if ((dateA >= now && dateB >= now)) {
            // Dates futures : plus proche en premier
            if (dateA.getTime() !== dateB.getTime()) {
              return dateA - dateB;
            }
          } else if ((dateA < now && dateB < now)) {
            // Dates pass√©es : plus r√©cente en premier
            if (dateA.getTime() !== dateB.getTime()) {
              return dateB - dateA;
            }
          } else {
            // Une future, une pass√©e : la future en premier
            return dateB >= now ? 1 : -1;
          }
          
          // 2. Si m√™me date, trier par lieu (site de plong√©e)
          if (a.lieu !== b.lieu) {
            return a.lieu.localeCompare(b.lieu, 'fr', { sensitivity: 'base' });
          }
          
          // 3. Si m√™me lieu, trier par type de session
          const ordreSession = ['matin', 'apr√®s-midi', 'soir', 'nuit', 'plg1', 'plg2', 'plg3', 'plg4', 'Formation', 'autre'];
          const indexA = ordreSession.indexOf(a.typeSession);
          const indexB = ordreSession.indexOf(b.typeSession);
          const posA = indexA === -1 ? 999 : indexA;
          const posB = indexB === -1 ? 999 : indexB;
          
          return posA - posB;
        });
        
        loadLieux();
        
        // Ne pas afficher automatiquement si on a des param√®tres URL
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.get('session')) {
          displaySessions(allSessions);
          updateStats(allSessions);
        }
        
        updateCalendar();
        
        // V√©rifier les param√®tres URL apr√®s le chargement
        checkURLParams();
        
      } catch (error) {
        console.error('Erreur:', error);
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }
    
    // Charger les lieux
    function loadLieux() {
      const lieux = new Set();
      allSessions.forEach(session => {
        if (session.lieu) lieux.add(session.lieu);
      });
      
      const lieuSelect = document.getElementById('search-lieu');
      lieuSelect.innerHTML = '<option value="">Tous les lieux</option>';
      
      Array.from(lieux).sort().forEach(lieu => {
        const option = document.createElement('option');
        option.value = lieu;
        option.textContent = lieu;
        lieuSelect.appendChild(option);
      });
    }
    
    // Afficher les sessions
    function displaySessions(sessions) {
      const container = document.getElementById('palanquees-container');
      const noResults = document.getElementById('no-results');
      
      if (sessions.length === 0) {
        container.innerHTML = '';
        noResults.style.display = 'block';
        return;
      }
      
      noResults.style.display = 'none';
      
      // Regrouper et trier toutes les palanqu√©es
      let allPalanquees = [];
      
      sessions.forEach(session => {
        session.palanquees.forEach(palanquee => {
          allPalanquees.push({
            ...palanquee,
            sessionId: session.id,
            date: session.date,
            dp: session.dp,
            lieu: session.lieu,
            typeSession: session.typeSession
          });
        });
      });
      
      // Trier les palanqu√©es selon les crit√®res
      const ordreSession = ['matin', 'apr√®s-midi', 'soir', 'nuit', 'plg1', 'plg2', 'plg3', 'plg4', 'Formation', 'autre'];
      
      allPalanquees.sort((a, b) => {
        // 1. Par date (plus proche en premier)
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        
        if (dateA.getTime() !== dateB.getTime()) {
          // Dates futures : plus proche en premier
          if (dateA >= now && dateB >= now) {
            return dateA - dateB;
          }
          // Dates pass√©es : plus r√©cente en premier
          else if (dateA < now && dateB < now) {
            return dateB - dateA;
          }
          // Une future, une pass√©e : future en premier
          else {
            return dateB >= now ? 1 : -1;
          }
        }
        
        // 2. Par type de session
        const indexA = ordreSession.indexOf(a.typeSession);
        const indexB = ordreSession.indexOf(b.typeSession);
        const posA = indexA === -1 ? 999 : indexA;
        const posB = indexB === -1 ? 999 : indexB;
        
        if (posA !== posB) {
          return posA - posB;
        }
        
        // 3. Par num√©ro de palanqu√©e
        return a.numero - b.numero;
      });
      
      // Afficher les palanqu√©es tri√©es
      container.innerHTML = allPalanquees.map(palanquee => {
        const dateObj = new Date(palanquee.date);
        const dateFormatted = dateObj.toLocaleDateString('fr-FR', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        // D√©terminer si c'est aujourd'hui, futur ou pass√©
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        dateObj.setHours(0, 0, 0, 0);
        
        let dateStatus = '';
        if (dateObj.getTime() === today.getTime()) {
          dateStatus = '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.8em;">AUJOURD\'HUI</span>';
        } else if (dateObj > today) {
          const daysUntil = Math.ceil((dateObj - today) / (1000 * 60 * 60 * 24));
          dateStatus = `<span style="background: #17a2b8; color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.8em;">Dans ${daysUntil} jour${daysUntil > 1 ? 's' : ''}</span>`;
        }
        
        return `
          <div class="palanquee-card">
            <button class="qr-button" onclick="showQRCode('${palanquee.sessionId}', ${palanquee.numero})">
              QR Code
            </button>
            
            <div class="session-header">
              <div class="session-date">üìÖ ${dateFormatted}</div>
              ${dateStatus}
              <div class="session-info">
                <span>üìç ${palanquee.lieu}</span>
                <span>üë®‚Äç‚úàÔ∏è ${palanquee.dp}</span>
              </div>
            </div>
            
            <div class="palanquee-title">
              Palanqu√©e #${palanquee.numero} - ${palanquee.typeSession}
            </div>
            
            <div class="palanquee-details">
              ${palanquee.horaire ? `
                <div class="detail-row">
                  <span class="detail-icon">üïê</span>
                  <span class="detail-label">Horaire:</span>
                  <span class="detail-value">${palanquee.horaire}</span>
                </div>
              ` : ''}
              
              ${palanquee.profPrevue ? `
                <div class="detail-row">
                  <span class="detail-icon">üåä</span>
                  <span class="detail-label">Prof. pr√©vue:</span>
                  <span class="detail-value">${palanquee.profPrevue} m</span>
                </div>
              ` : ''}
              
              ${palanquee.dureePrevue ? `
                <div class="detail-row">
                  <span class="detail-icon">‚è±Ô∏è</span>
                  <span class="detail-label">Dur√©e pr√©vue:</span>
                  <span class="detail-value">${palanquee.dureePrevue} min</span>
                </div>
              ` : ''}
              
              ${palanquee.profRealisee ? `
                <div class="detail-row">
                  <span class="detail-icon">üéØ</span>
                  <span class="detail-label">Prof. r√©alis√©e:</span>
                  <span class="detail-value">${palanquee.profRealisee} m</span>
                </div>
              ` : ''}
              
              ${palanquee.dureeRealisee ? `
                <div class="detail-row">
                  <span class="detail-icon">‚è±Ô∏è</span>
                  <span class="detail-label">Dur√©e r√©alis√©e:</span>
                  <span class="detail-value">${palanquee.dureeRealisee} min</span>
                </div>
              ` : ''}
            </div>
            
            ${palanquee.paliers ? `
              <div class="paliers-info">
                <strong>‚ö†Ô∏è Paliers effectu√©s:</strong> ${palanquee.paliers}
              </div>
            ` : ''}
            
            <div class="plongeurs-list">
              <div class="plongeurs-title">üë• Plongeurs (${palanquee.plongeurs.length})</div>
              ${palanquee.plongeurs.map((plongeur, idx) => `
                <div class="plongeur-item">
                  <div style="display: flex; align-items: center; flex: 1;">
                    <span class="plongeur-rank">#${idx + 1}</span>
                    <span class="plongeur-name">${plongeur.nom}</span>
                  </div>
                  <div class="plongeur-badges">
                    ${plongeur.pre ? `<span class="pre-badge">${plongeur.pre}</span>` : ''}
                    <span class="niveau-badge">${plongeur.niveau}</span>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }
            </div>
            
            <div class="palanquee-title">
              Palanqu√©e #${palanquee.numero} - ${session.typeSession}
            </div>
            
            <div class="palanquee-details">
              ${palanquee.horaire ? `
                <div class="detail-row">
                  <span class="detail-icon">üïê</span>
                  <span class="detail-label">Horaire:</span>
                  <span class="detail-value">${palanquee.horaire}</span>
                </div>
              ` : ''}
              
              ${palanquee.profPrevue ? `
                <div class="detail-row">
                  <span class="detail-icon">üåä</span>
                  <span class="detail-label">Prof. pr√©vue:</span>
                  <span class="detail-value">${palanquee.profPrevue} m</span>
                </div>
              ` : ''}
              
              ${palanquee.dureePrevue ? `
                <div class="detail-row">
                  <span class="detail-icon">‚è±Ô∏è</span>
                  <span class="detail-label">Dur√©e pr√©vue:</span>
                  <span class="detail-value">${palanquee.dureePrevue} min</span>
                </div>
              ` : ''}
              
              ${palanquee.profRealisee ? `
                <div class="detail-row">
                  <span class="detail-icon">üéØ</span>
                  <span class="detail-label">Prof. r√©alis√©e:</span>
                  <span class="detail-value">${palanquee.profRealisee} m</span>
                </div>
              ` : ''}
              
              ${palanquee.dureeRealisee ? `
                <div class="detail-row">
                  <span class="detail-icon">‚è±Ô∏è</span>
                  <span class="detail-label">Dur√©e r√©alis√©e:</span>
                  <span class="detail-value">${palanquee.dureeRealisee} min</span>
                </div>
              ` : ''}
            </div>
            
            ${palanquee.paliers ? `
              <div class="paliers-info">
                <strong>‚ö†Ô∏è Paliers effectu√©s:</strong> ${palanquee.paliers}
              </div>
            ` : ''}
            
            <div class="plongeurs-list">
              <div class="plongeurs-title">üë• Plongeurs (${palanquee.plongeurs.length})</div>
              ${palanquee.plongeurs.map((plongeur, idx) => `
                <div class="plongeur-item">
                  <div style="display: flex; align-items: center; flex: 1;">
                    <span class="plongeur-rank">#${idx + 1}</span>
                    <span class="plongeur-name">${plongeur.nom}</span>
                  </div>
                  <div class="plongeur-badges">
                    ${plongeur.pre ? `<span class="pre-badge">${plongeur.pre}</span>` : ''}
                    <span class="niveau-badge">${plongeur.niveau}</span>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `).join('');
      }).join('');
    }
    
    // Vue Calendrier
    function switchView(view) {
      currentView = view;
      const buttons = document.querySelectorAll('.view-btn');
      buttons.forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      if (view === 'calendar') {
        document.getElementById('palanquees-container').style.display = 'none';
        document.getElementById('calendar-view').style.display = 'block';
        updateCalendar();
      } else {
        document.getElementById('palanquees-container').style.display = 'grid';
        document.getElementById('calendar-view').style.display = 'none';
      }
    }
    
    function updateCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      // Afficher le mois/ann√©e
      const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                         'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
      document.getElementById('calendar-month').textContent = `${monthNames[month]} ${year}`;
      
      // Cr√©er la grille du calendrier
      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();
      const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1; // Ajuster pour lundi = 0
      
      let calendarHTML = '';
      
      // En-t√™tes des jours
      const dayHeaders = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
      dayHeaders.forEach(day => {
        calendarHTML += `<div class="calendar-day-header">${day}</div>`;
      });
      
      // Jours vides au d√©but
      for (let i = 0; i < adjustedFirstDay; i++) {
        calendarHTML += '<div class="calendar-day" style="background: #f8f9fa;"></div>';
      }
      
      // Jours du mois
      for (let date = 1; date <= lastDate; date++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
        const sessionsForDay = (filteredSessions.length ? filteredSessions : allSessions)
          .filter(s => s.date === dateStr);
        
        let dayClass = 'calendar-day';
        if (sessionsForDay.length > 0) dayClass += ' has-sessions';
        
        const today = new Date();
        if (year === today.getFullYear() && month === today.getMonth() && date === today.getDate()) {
          dayClass += ' selected';
        }
        
        calendarHTML += `
          <div class="${dayClass}" onclick="filterByDate('${dateStr}')">
            <div class="calendar-day-number">${date}</div>
            ${sessionsForDay.length > 0 ? `
              <div class="calendar-day-sessions">
                ${sessionsForDay.map(s => `
                  <span class="calendar-session-badge" title="${s.lieu} - ${s.dp}">
                    ${s.palanquees.length} pal.
                  </span>
                `).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }
      
      document.getElementById('calendar-grid').innerHTML = calendarHTML;
    }
    
    function previousMonth() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      updateCalendar();
    }
    
    function nextMonth() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      updateCalendar();
    }
    
    function currentMonth() {
      currentDate = new Date();
      updateCalendar();
    }
    
    function filterByDate(dateStr) {
      document.getElementById('search-date').value = dateStr;
      searchPalanquees();
      switchView('list');
    }
    
    // QR Code
    function showQRCode(sessionId, palanqueeNum) {
      const modal = document.getElementById('qr-modal');
      const qrDiv = document.getElementById('qr-code');
      
      // Cr√©er l'URL avec les infos de la session
      const baseUrl = window.location.origin + window.location.pathname;
      const qrUrl = `${baseUrl}?session=${sessionId}&palanquee=${palanqueeNum}`;
      
      // Vider le contenu pr√©c√©dent
      qrDiv.innerHTML = '';
      
      // G√©n√©rer le QR code
      new QRCode(qrDiv, {
        text: qrUrl,
        width: 256,
        height: 256,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
      
      modal.style.display = 'flex';
    }
    
    function closeQRModal() {
      document.getElementById('qr-modal').style.display = 'none';
    }
    
    // Export PDF
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Titre
      doc.setFontSize(20);
      doc.setTextColor(111, 66, 193);
      doc.text('JSA Subaquatique - Palanqu√©es', 105, 20, { align: 'center' });
      
      // Date d'export
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text(`Export du ${new Date().toLocaleDateString('fr-FR')}`, 105, 30, { align: 'center' });
      
      // Pr√©parer les donn√©es pour le tableau
      const tableData = [];
      const sessions = filteredSessions.length ? filteredSessions : allSessions;
      
      sessions.forEach(session => {
        session.palanquees.forEach(palanquee => {
          // Premi√®re ligne avec infos de la palanqu√©e
          tableData.push([
            new Date(session.date).toLocaleDateString('fr-FR'),
            session.lieu,
            session.dp,
            `Pal. ${palanquee.numero}`,
            palanquee.horaire || '-',
            `${palanquee.profPrevue || '-'} m`,
            palanquee.paliers || 'Aucun'
          ]);
          
          // Lignes des plongeurs
          palanquee.plongeurs.forEach((plongeur, idx) => {
            tableData.push([
              '', '', '', '',
              `#${idx + 1} ${plongeur.nom}`,
              plongeur.niveau,
              plongeur.pre || ''
            ]);
          });
        });
      });
      
      // Cr√©er le tableau
      doc.autoTable({
        startY: 40,
        head: [['Date', 'Lieu', 'DP', 'Palanqu√©e', 'Horaire/Plongeur', 'Prof./Niveau', 'Paliers/Pr√©roga.']],
        body: tableData,
        styles: {
          fontSize: 9,
          cellPadding: 2
        },
        headStyles: {
          fillColor: [111, 66, 193],
          textColor: 255
        },
        alternateRowStyles: {
          fillColor: [245, 245, 250]
        },
        columnStyles: {
          0: { cellWidth: 25 },
          1: { cellWidth: 30 },
          2: { cellWidth: 35 },
          3: { cellWidth: 20 },
          4: { cellWidth: 45 },
          5: { cellWidth: 25 },
          6: { cellWidth: 25 }
        }
      });
      
      // Footer
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(`Page ${i} / ${pageCount}`, 105, 285, { align: 'center' });
      }
      
      // Sauvegarder
      doc.save(`palanquees_JSA_${new Date().toISOString().split('T')[0]}.pdf`);
    }
    
    // Rechercher les palanqu√©es
    function searchPalanquees() {
      const name = document.getElementById('search-name').value.toLowerCase();
      const date = document.getElementById('search-date').value;
      const lieu = document.getElementById('search-lieu').value;
      
      filteredSessions = allSessions.filter(session => {
        if (lieu && session.lieu !== lieu) return false;
        if (date && session.date !== date) return false;
        
        if (name) {
          const hasName = session.palanquees.some(palanquee =>
            palanquee.plongeurs.some(plongeur =>
              plongeur.nom.toLowerCase().includes(name)
            )
          );
          if (!hasName) return false;
        }
        
        return true;
      });
      
      if (name) {
        filteredSessions = filteredSessions.map(session => ({
          ...session,
          palanquees: session.palanquees.filter(palanquee =>
            palanquee.plongeurs.some(plongeur =>
              plongeur.nom.toLowerCase().includes(name)
            )
          )
        }));
      }
      
      displaySessions(filteredSessions);
      updateStats(filteredSessions);
      updateCalendar();
    }
    
    // Filtres rapides
    function filterToday(chip) {
      resetChips();
      chip.classList.add('active');
      const today = new Date().toISOString().split('T')[0];
      filteredSessions = allSessions.filter(s => s.date === today);
      displaySessions(filteredSessions);
      updateStats(filteredSessions);
      updateCalendar();
    }
    
    function filterWeek(chip) {
      resetChips();
      chip.classList.add('active');
      const today = new Date();
      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      filteredSessions = allSessions.filter(s => {
        const sDate = new Date(s.date);
        return sDate >= weekAgo && sDate <= today;
      });
      displaySessions(filteredSessions);
      updateStats(filteredSessions);
      updateCalendar();
    }
    
    function filterMonth(chip) {
      resetChips();
      chip.classList.add('active');
      const today = new Date();
      const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
      filteredSessions = allSessions.filter(s => {
        const sDate = new Date(s.date);
        return sDate >= monthAgo && sDate <= today;
      });
      displaySessions(filteredSessions);
      updateStats(filteredSessions);
      updateCalendar();
    }
    
    function filterMyPalanquees(chip) {
      const name = prompt('Entrez votre nom complet:');
      if (name) {
        resetChips();
        chip.classList.add('active');
        document.getElementById('search-name').value = name;
        searchPalanquees();
      }
    }
    
    function showAll(chip) {
      resetChips();
      chip.classList.add('active');
      document.getElementById('search-name').value = '';
      document.getElementById('search-date').value = '';
      document.getElementById('search-lieu').value = '';
      filteredSessions = [];
      displaySessions(allSessions);
      updateStats(allSessions);
      updateCalendar();
    }
    
    function resetChips() {
      document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    }
    
    // Mettre √† jour les statistiques
    function updateStats(sessions) {
      const today = new Date().toISOString().split('T')[0];
      const weekAgo = new Date(new Date().getTime() - 7 * 24 * 60 * 60 * 1000);
      
      document.getElementById('stat-total').textContent = sessions.length;
      document.getElementById('stat-today').textContent = 
        sessions.filter(s => s.date === today).length;
      document.getElementById('stat-week').textContent = 
        sessions.filter(s => {
          const sDate = new Date(s.date);
          return sDate >= weekAgo;
        }).length;
      
      const uniquePlongeurs = new Set();
      sessions.forEach(session => {
        session.palanquees.forEach(palanquee => {
          palanquee.plongeurs.forEach(plongeur => {
            uniquePlongeurs.add(plongeur.nom);
          });
        });
      });
      document.getElementById('stat-plongeurs').textContent = uniquePlongeurs.size;
    }
    
    // Rafra√Æchir les donn√©es
    function refreshData() {
      const btn = document.querySelector('.refresh-btn');
      btn.style.transform = 'rotate(360deg)';
      setTimeout(() => {
        loadData();
        btn.style.transform = 'rotate(0deg)';
      }, 500);
    }
    
    // G√©rer les param√®tres d'URL (pour QR code)
    function checkURLParams() {
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get('session');
      const palanqueeNum = urlParams.get('palanquee');
      
      if (sessionId && palanqueeNum) {
        // Attendre que les donn√©es soient charg√©es
        setTimeout(() => {
          // Filtrer pour afficher uniquement cette session/palanqu√©e
          const sessionFiltered = allSessions.filter(s => s.id === sessionId);
          if (sessionFiltered.length > 0) {
            // Ne garder que la palanqu√©e sp√©cifique
            const session = {...sessionFiltered[0]};
            session.palanquees = session.palanquees.filter(p => p.numero == palanqueeNum);
            
            if (session.palanquees.length > 0) {
              // Afficher uniquement cette palanqu√©e
              displaySessions([session]);
              updateStats([session]);
              
              // Ajouter un message d'info
              const header = document.querySelector('.header');
              const existingAlert = document.getElementById('qr-alert');
              if (!existingAlert) {
                header.insertAdjacentHTML('afterend', `
                  <div id="qr-alert" style="
                    background: #d4edda;
                    color: #155724;
                    padding: 15px;
                    border-radius: 10px;
                    margin: 20px 0;
                    text-align: center;
                    border: 1px solid #c3e6cb;
                  ">
                    üéØ Affichage de la palanqu√©e #${palanqueeNum} du ${new Date(session.date).toLocaleDateString('fr-FR')}
                    <button onclick="clearFilter()" style="
                      margin-left: 20px;
                      padding: 5px 15px;
                      background: #28a745;
                      color: white;
                      border: none;
                      border-radius: 5px;
                      cursor: pointer;
                    ">
                      Voir toutes les palanqu√©es
                    </button>
                  </div>
                `);
              }
              
              // Mettre √† jour les filtres pour refl√©ter la s√©lection
              document.getElementById('search-date').value = session.date;
            }
          }
        }, 1000);
      }
    }
    
    // Fonction pour effacer le filtre QR
    function clearFilter() {
      // Retirer les param√®tres de l'URL
      window.history.replaceState({}, document.title, window.location.pathname);
      
      // Retirer l'alerte
      const alert = document.getElementById('qr-alert');
      if (alert) alert.remove();
      
      // R√©initialiser l'affichage
      document.getElementById('search-name').value = '';
      document.getElementById('search-date').value = '';
      document.getElementById('search-lieu').value = '';
      showAll(document.querySelector('.chip.active'));
    }
    
    // Charger au d√©marrage
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      setInterval(loadData, 5 * 60 * 1000);
    });
  </script>
</body>
</html>