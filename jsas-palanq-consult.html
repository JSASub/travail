<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSA - Consultation des Palanqu√©es</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <!-- Librairies pour PDF et QR Code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      text-align: center;
    }
    
    .header h1 {
      color: #6f42c1;
      margin-bottom: 10px;
    }
    
    .header .mode-badge {
      display: inline-block;
      background: #28a745;
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
    }
    
    .view-toggle {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }
    
    .view-btn {
      padding: 10px 20px;
      border: 2px solid #6f42c1;
      background: white;
      color: #6f42c1;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
    }
    
    .view-btn.active {
      background: #6f42c1;
      color: white;
    }
    
    .search-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .search-box {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .search-box input, .search-box select {
      flex: 1;
      min-width: 200px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .search-box input:focus, .search-box select:focus {
      outline: none;
      border-color: #6f42c1;
    }
    
    .btn-search {
      background: #6f42c1;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
    }
    
    .btn-search:hover {
      background: #5a32a3;
    }
    
    .export-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .btn-export {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .btn-pdf {
      background: #dc3545;
      color: white;
    }
    
    .btn-pdf:hover {
      background: #c82333;
    }
    
    /* Vue Calendrier */
    .calendar-view {
      display: none;
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .calendar-nav {
      display: flex;
      gap: 10px;
    }
    
    .calendar-btn {
      padding: 8px 15px;
      background: #6f42c1;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .calendar-btn:hover {
      background: #5a32a3;
    }
    
    .calendar-month {
      font-size: 1.5em;
      color: #333;
      font-weight: bold;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #ddd;
      border: 1px solid #ddd;
    }
    
    .calendar-day-header {
      background: #f8f9fa;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      color: #666;
    }
    
    .calendar-day {
      background: white;
      min-height: 80px;
      padding: 8px;
      cursor: pointer;
      transition: background 0.3s;
      position: relative;
    }
    
    .calendar-day:hover {
      background: #f0f0f0;
    }
    
    .calendar-day-number {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .calendar-day-sessions {
      font-size: 0.8em;
    }
    
    .calendar-session-badge {
      display: inline-block;
      background: #6f42c1;
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      margin: 2px;
      font-size: 0.75em;
    }
    
    .calendar-day.has-sessions {
      background: #e3f2fd;
    }
    
    .calendar-day.selected {
      background: #6f42c1;
      color: white;
    }
    
    .calendar-day.selected .calendar-session-badge {
      background: white;
      color: #6f42c1;
    }
    
    /* Vue Liste */
    .palanquees-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .palanquee-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      position: relative;
    }
    
    .palanquee-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    .qr-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #007bff;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.8em;
    }
    
    .qr-button:hover {
      background: #0056b3;
    }
    
    .session-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: -20px -20px 20px -20px;
      text-align: center;
    }
    
    .session-date {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .session-info {
      display: flex;
      justify-content: center;
      gap: 20px;
      font-size: 0.9em;
      opacity: 0.95;
    }
    
    .palanquee-title {
      font-size: 1.1em;
      color: #333;
      font-weight: bold;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .palanquee-details {
      display: grid;
      gap: 8px;
      margin-bottom: 15px;
      font-size: 0.95em;
    }
    
    .detail-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .detail-icon {
      width: 20px;
      text-align: center;
    }
    
    .detail-label {
      font-weight: 600;
      color: #666;
      min-width: 100px;
    }
    
    .detail-value {
      color: #333;
    }
    
    .paliers-info {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 5px;
      padding: 8px;
      margin-top: 10px;
      font-size: 0.9em;
      color: #856404;
    }
    
    .plongeurs-list {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-top: 15px;
    }
    
    .plongeurs-title {
      font-size: 0.9em;
      font-weight: bold;
      color: #666;
      margin-bottom: 10px;
    }
    
    .plongeur-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin: 5px 0;
      background: white;
      border-radius: 5px;
      border-left: 4px solid #6f42c1;
    }
    
    .plongeur-rank {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.8em;
      margin-right: 8px;
      font-weight: bold;
      color: #666;
    }
    
    .plongeur-name {
      font-weight: 500;
      color: #333;
      flex: 1;
    }
    
    .plongeur-badges {
      display: flex;
      gap: 5px;
    }
    
    .niveau-badge {
      background: #6f42c1;
      color: white;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.85em;
      font-weight: bold;
    }
    
    .pre-badge {
      background: #17a2b8;
      color: white;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.85em;
    }
    
    .no-results {
      background: white;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      color: #999;
    }
    
    .stats-banner {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      text-align: center;
    }
    
    .stat-item {
      padding: 10px;
    }
    
    .stat-value {
      font-size: 2em;
      color: #6f42c1;
      font-weight: bold;
    }
    
    .stat-label {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
    }
    
    .filter-chips {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }
    
    .chip {
      background: #e0e0e0;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .chip.active {
      background: #6f42c1;
      color: white;
    }
    
    .chip:hover {
      background: #d0d0d0;
    }
    
    .chip.active:hover {
      background: #5a32a3;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
    }
    
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Modal QR Code */
    .qr-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .qr-modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      max-width: 400px;
    }
    
    .qr-modal-title {
      font-size: 1.2em;
      margin-bottom: 20px;
      color: #333;
    }
    
    .qr-modal-close {
      margin-top: 20px;
      padding: 10px 20px;
      background: #6f42c1;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    @media (max-width: 768px) {
      .search-box {
        flex-direction: column;
      }
      
      .search-box input, .search-box select {
        width: 100%;
      }
      
      .palanquees-grid {
        grid-template-columns: 1fr;
      }
      
      .calendar-grid {
        font-size: 0.8em;
      }
      
      .calendar-day {
        min-height: 60px;
        padding: 5px;
      }
    }
    
    .footer {
      text-align: center;
      color: white;
      margin-top: 40px;
      padding: 20px;
    }
    
    .refresh-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #28a745;
      color: white;
      border: none;
      padding: 15px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      font-size: 1.5em;
      transition: transform 0.3s;
      z-index: 100;
    }
    
    .refresh-btn:hover {
      transform: rotate(180deg);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- En-t√™te -->
    <div class="header">
      <h1>ü§ø JSA Subaquatique - Palanqu√©es</h1>
      <div class="mode-badge">üëÅÔ∏è Mode Consultation</div>
      <p style="margin-top: 10px; color: #666;">Consultez les palanqu√©es et trouvez vos sessions de plong√©e</p>
      
      <!-- Boutons de vue -->
      <div class="view-toggle">
        <button class="view-btn active" onclick="switchView('list')">üìã Liste</button>
        <button class="view-btn" onclick="switchView('calendar')">üìÖ Calendrier</button>
      </div>
    </div>
    
    <!-- Statistiques -->
    <div class="stats-banner" id="stats">
      <div class="stat-item">
        <div class="stat-value" id="stat-total">0</div>
        <div class="stat-label">Sessions totales</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-today">0</div>
        <div class="stat-label">Aujourd'hui</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-week">0</div>
        <div class="stat-label">Cette semaine</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-plongeurs">0</div>
        <div class="stat-label">Plongeurs actifs</div>
      </div>
    </div>
    
    <!-- Section recherche -->
    <div class="search-section">
      <h2 style="margin-bottom: 15px; color: #333;">üîç Rechercher une palanqu√©e</h2>
      
      <div class="search-box">
        <input type="text" id="search-name" placeholder="Votre nom..." />
        <input type="date" id="search-date" />
        <select id="search-lieu">
          <option value="">Tous les lieux</option>
        </select>
        <button class="btn-search" onclick="searchPalanquees()">
          üîç Rechercher
        </button>
      </div>
      
      <!-- Filtres rapides -->
      <div class="filter-chips">
        <div class="chip" onclick="filterToday(this)">üìÖ Aujourd'hui</div>
        <div class="chip" onclick="filterWeek(this)">üìÜ Cette semaine</div>
        <div class="chip" onclick="filterMonth(this)">üìä Ce mois</div>
        <div class="chip" onclick="filterMyPalanquees(this)">üë§ Mes palanqu√©es</div>
        <div class="chip active" onclick="showAll(this)">üìã Tout afficher</div>
      </div>
      
      <!-- Boutons d'export -->
      <div class="export-buttons">
        <button class="btn-export btn-pdf" onclick="exportPDF()">üìÑ Exporter en PDF</button>
      </div>
    </div>
    
    <!-- Chargement -->
    <div id="loading" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>Chargement des donn√©es...</p>
    </div>
    
    <!-- Vue Calendrier -->
    <div class="calendar-view" id="calendar-view">
      <div class="calendar-header">
        <div class="calendar-nav">
          <button class="calendar-btn" onclick="previousMonth()">‚óÄ</button>
          <button class="calendar-btn" onclick="currentMonth()">Aujourd'hui</button>
          <button class="calendar-btn" onclick="nextMonth()">‚ñ∂</button>
        </div>
        <div class="calendar-month" id="calendar-month"></div>
      </div>
      <div class="calendar-grid" id="calendar-grid"></div>
    </div>
    
    <!-- Vue Liste -->
    <div class="palanquees-grid" id="palanquees-container">
      <!-- Les palanqu√©es seront affich√©es ici -->
    </div>
    
    <!-- Message si pas de r√©sultats -->
    <div class="no-results" id="no-results" style="display: none;">
      <h3>üîç Aucune palanqu√©e trouv√©e</h3>
      <p>Modifiez vos crit√®res de recherche ou consultez toutes les palanqu√©es</p>
    </div>
  </div>
  
  <!-- Modal QR Code -->
  <div class="qr-modal" id="qr-modal">
    <div class="qr-modal-content">
      <h3 class="qr-modal-title">QR Code de la session</h3>
      <div id="qr-code"></div>
      <button class="qr-modal-close" onclick="closeQRModal()">Fermer</button>
    </div>
  </div>
  
  <!-- Bouton rafra√Æchir -->
  <button class="refresh-btn" onclick="refreshData()" title="Rafra√Æchir les donn√©es">
    üîÑ
  </button>
  
  <!-- Footer -->
  <div class="footer">
    <p>Version consultation publique - Lecture seule</p>
    <p style="font-size: 0.9em; opacity: 0.8;">JSA Subaquatique ¬© 2025</p>
  </div>

  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA9FO6BiHkm7dOQ3Z4-wpPQRgnsGKg3pmM",
      authDomain: "palanquees-jsas.firebaseapp.com",
      databaseURL: "https://palanquees-jsas-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "palanquees-jsas",
      storageBucket: "palanquees-jsas.firebasestorage.app",
      messagingSenderId: "284449736616",
      appId: "1:284449736616:web:a0949a9b669def06323f9d"
    };

    let app, db;
    let allSessions = [];
    let filteredSessions = [];
    let currentView = 'list';
    let currentDate = new Date();
    
    // Ordre des niveaux pour le tri
    const ORDRE_NIVEAUX = ['E4', 'E3', 'E2', 'N4/GP', 'GP', 'N4', 'N3', 'N2', 'N1', 'Plg.Or', 'Plg.Ar', 'Plg.Br', 'D√©b.', 'd√©butant', 'D√©b'];
    
    // Initialisation Firebase
    try {
      app = firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      console.log('‚úÖ Firebase initialis√©');
    } catch (error) {
      console.error('‚ùå Erreur Firebase:', error);
    }
    
    // Fonction de tri des plongeurs
    function trierPlongeursParNiveau(plongeurs) {
      return [...plongeurs].sort((a, b) => {
        const indexA = ORDRE_NIVEAUX.indexOf(a.niveau);
        const indexB = ORDRE_NIVEAUX.indexOf(b.niveau);
        const posA = indexA === -1 ? 999 : indexA;
        const posB = indexB === -1 ? 999 : indexB;
        
        if (posA === posB) {
          // Si m√™me niveau, trier par nom
          return a.nom.localeCompare(b.nom, 'fr', { sensitivity: 'base' });
        }
        return posA - posB;
      });
    }
    
    // Charger toutes les donn√©es
    async function loadData() {
      if (!db) {
        console.error('Base de donn√©es non initialis√©e');
        return;
      }
      
      document.getElementById('loading').style.display = 'block';
      
      try {
        console.log('Chargement des donn√©es depuis Firebase...');
        const snapshot = await db.ref('sessions').once('value');
        
        if (!snapshot.exists()) {
          console.log('Aucune donn√©e trouv√©e dans Firebase');
          document.getElementById('no-results').style.display = 'block';
          document.getElementById('loading').style.display = 'none';
          return;
        }
        
        const sessions = snapshot.val();
        console.log('Donn√©es re√ßues:', Object.keys(sessions).length, 'sessions');
        allSessions = [];
        
        Object.entries(sessions).forEach(([key, session]) => {
          if (!session.meta || !session.palanquees) return;
          
          const sessionData = {
            id: key,
            date: session.meta.date,
            dp: session.meta.dp,
            lieu: session.meta.lieu,
            typeSession: session.meta.plongee || 'matin',
            palanquees: []
          };
          
          session.palanquees.forEach((palanquee, idx) => {
            if (!palanquee || !palanquee.plongeurs) return;
            
            // Trier les plongeurs par niveau puis par nom
            const plongeursTries = trierPlongeursParNiveau(palanquee.plongeurs);
            
            sessionData.palanquees.push({
              numero: idx + 1,
              horaire: palanquee.parametres?.horaire || '',
              profPrevue: palanquee.parametres?.profondeurPrevue || '',
              dureePrevue: palanquee.parametres?.dureePrevue || '',
              profRealisee: palanquee.parametres?.profondeurRealisee || '',
              dureeRealisee: palanquee.parametres?.dureeRealisee || '',
              paliers: palanquee.parametres?.paliers || '',
              plongeurs: plongeursTries
            });
          });
          
          if (sessionData.palanquees.length > 0) {
            allSessions.push(sessionData);
          }
        });
        
        console.log('Sessions trait√©es:', allSessions.length);
        
        // Trier par date, puis lieu, puis type de session
        allSessions.sort((a, b) => {
          // 1. Trier par date (plus proche en premier)
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          const now = new Date();
          now.setHours(0, 0, 0, 0);
          
          // Dates futures d'abord, puis pass√©es
          if (dateA.getTime() !== dateB.getTime()) {
            if (dateA >= now && dateB >= now) {
              return dateA - dateB; // Futures : plus proche en premier
            } else if (dateA < now && dateB < now) {
              return dateB - dateA; // Pass√©es : plus r√©cente en premier
            } else {
              return dateB >= now ? 1 : -1; // Future avant pass√©e
            }
          }
          
          // 2. Si m√™me date, trier par lieu (site de plong√©e)
          if (a.lieu !== b.lieu) {
            return a.lieu.localeCompare(b.lieu, 'fr', { sensitivity: 'base' });
          }
          
          // 3. Si m√™me lieu, trier par type de session
          const ordreSession = ['matin', 'apr√®s-midi', 'soir', 'nuit', 'plg1', 'plg2', 'plg3', 'plg4', 'Formation', 'autre'];
          const indexA = ordreSession.indexOf(a.typeSession);
          const indexB = ordreSession.indexOf(b.typeSession);
          const posA = indexA === -1 ? 999 : indexA;
          const posB = indexB === -1 ? 999 : indexB;
          
          return posA - posB;
        });
        
        console.log('Tri termin√©');
        
        loadLieux();
        
        // Ne pas afficher automatiquement si on a des param√®tres URL
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.get('session')) {
          displaySessions(allSessions);
          updateStats(allSessions);
        }
        
        updateCalendar();
        
        // V√©rifier les param√®tres URL apr√®s le chargement
        checkURLParams();
        
      } catch (error) {
        console.error('Erreur lors du chargement:', error);
        alert('Erreur lors du chargement des donn√©es: ' + error.message);
      } finally {
        document.getElementById('loading