<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSA - Consultation des Palanqu√©es</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      text-align: center;
    }
    
    .header h1 {
      color: #6f42c1;
      margin-bottom: 10px;
    }
    
    .header .mode-badge {
      display: inline-block;
      background: #28a745;
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
    }
    
    .search-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .search-box {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .search-box input, .search-box select {
      flex: 1;
      min-width: 200px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .search-box input:focus, .search-box select:focus {
      outline: none;
      border-color: #6f42c1;
    }
    
    .btn-search {
      background: #6f42c1;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
    }
    
    .btn-search:hover {
      background: #5a32a3;
    }
    
    .palanquees-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .palanquee-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .palanquee-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    .session-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: -20px -20px 20px -20px;
      text-align: center;
    }
    
    .session-date {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .session-info {
      display: flex;
      justify-content: center;
      gap: 20px;
      font-size: 0.9em;
      opacity: 0.95;
    }
    
    .palanquee-title {
      font-size: 1.1em;
      color: #333;
      font-weight: bold;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .palanquee-details {
      display: grid;
      gap: 8px;
      margin-bottom: 15px;
      font-size: 0.95em;
    }
    
    .detail-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .detail-icon {
      width: 20px;
      text-align: center;
    }
    
    .detail-label {
      font-weight: 600;
      color: #666;
      min-width: 100px;
    }
    
    .detail-value {
      color: #333;
    }
    
    .plongeurs-list {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-top: 15px;
    }
    
    .plongeurs-title {
      font-size: 0.9em;
      font-weight: bold;
      color: #666;
      margin-bottom: 10px;
    }
    
    .plongeur-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin: 5px 0;
      background: white;
      border-radius: 5px;
      border-left: 4px solid #6f42c1;
    }
    
    .plongeur-name {
      font-weight: 500;
      color: #333;
    }
    
    .plongeur-badges {
      display: flex;
      gap: 5px;
    }
    
    .niveau-badge {
      background: #6f42c1;
      color: white;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.85em;
      font-weight: bold;
    }
    
    .pre-badge {
      background: #17a2b8;
      color: white;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.85em;
    }
    
    .no-results {
      background: white;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      color: #999;
    }
    
    .stats-banner {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      text-align: center;
    }
    
    .stat-item {
      padding: 10px;
    }
    
    .stat-value {
      font-size: 2em;
      color: #6f42c1;
      font-weight: bold;
    }
    
    .stat-label {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
    }
    
    .filter-chips {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }
    
    .chip {
      background: #e0e0e0;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .chip.active {
      background: #6f42c1;
      color: white;
    }
    
    .chip:hover {
      background: #d0d0d0;
    }
    
    .chip.active:hover {
      background: #5a32a3;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
    }
    
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .search-box {
        flex-direction: column;
      }
      
      .search-box input, .search-box select {
        width: 100%;
      }
      
      .palanquees-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .footer {
      text-align: center;
      color: white;
      margin-top: 40px;
      padding: 20px;
    }
    
    .refresh-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #28a745;
      color: white;
      border: none;
      padding: 15px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      font-size: 1.5em;
      transition: transform 0.3s;
      z-index: 100;
    }
    
    .refresh-btn:hover {
      transform: rotate(180deg);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- En-t√™te -->
    <div class="header">
      <h1>ü§ø JSA Subaquatique - Palanqu√©es</h1>
      <div class="mode-badge">üëÅÔ∏è Mode Consultation</div>
      <p style="margin-top: 10px; color: #666;">Consultez les palanqu√©es et trouvez vos sessions de plong√©e</p>
    </div>
    
    <!-- Statistiques -->
    <div class="stats-banner" id="stats">
      <div class="stat-item">
        <div class="stat-value" id="stat-total">0</div>
        <div class="stat-label">Sessions totales</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-today">0</div>
        <div class="stat-label">Aujourd'hui</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-week">0</div>
        <div class="stat-label">Cette semaine</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-plongeurs">0</div>
        <div class="stat-label">Plongeurs actifs</div>
      </div>
    </div>
    
    <!-- Section recherche -->
    <div class="search-section">
      <h2 style="margin-bottom: 15px; color: #333;">üîç Rechercher une palanqu√©e</h2>
      
      <div class="search-box">
        <input type="text" id="search-name" placeholder="Votre nom..." />
        <input type="date" id="search-date" />
        <select id="search-lieu">
          <option value="">Tous les lieux</option>
        </select>
        <button class="btn-search" onclick="searchPalanquees()">
          üîç Rechercher
        </button>
      </div>
      
      <!-- Filtres rapides -->
      <div class="filter-chips">
        <div class="chip" onclick="filterToday(this)">üìÖ Aujourd'hui</div>
        <div class="chip" onclick="filterWeek(this)">üìÜ Cette semaine</div>
        <div class="chip" onclick="filterMonth(this)">üìä Ce mois</div>
        <div class="chip" onclick="filterMyPalanquees(this)">üë§ Mes palanqu√©es</div>
        <div class="chip" onclick="showAll(this)">üìã Tout afficher</div>
      </div>
    </div>
    
    <!-- Chargement -->
    <div id="loading" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>Chargement des donn√©es...</p>
    </div>
    
    <!-- Grille des palanqu√©es -->
    <div class="palanquees-grid" id="palanquees-container">
      <!-- Les palanqu√©es seront affich√©es ici -->
    </div>
    
    <!-- Message si pas de r√©sultats -->
    <div class="no-results" id="no-results" style="display: none;">
      <h3>üîç Aucune palanqu√©e trouv√©e</h3>
      <p>Modifiez vos crit√®res de recherche ou consultez toutes les palanqu√©es</p>
    </div>
  </div>
  
  <!-- Bouton rafra√Æchir -->
  <button class="refresh-btn" onclick="refreshData()" title="Rafra√Æchir les donn√©es">
    üîÑ
  </button>
  
  <!-- Footer -->
  <div class="footer">
    <p>Version consultation publique - Lecture seule</p>
    <p style="font-size: 0.9em; opacity: 0.8;">JSA Subaquatique ¬© 2025</p>
  </div>

  <script>
    // Configuration Firebase (identique √† bilan-palanquees.html)
    const firebaseConfig = {
      apiKey: "AIzaSyA9FO6BiHkm7dOQ3Z4-wpPQRgnsGKg3pmM",
      authDomain: "palanquees-jsas.firebaseapp.com",
      databaseURL: "https://palanquees-jsas-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "palanquees-jsas",
      storageBucket: "palanquees-jsas.firebasestorage.app",
      messagingSenderId: "284449736616",
      appId: "1:284449736616:web:a0949a9b669def06323f9d"
    };

    let app, db;
    let allSessions = [];
    let filteredSessions = [];
    
    // Initialisation Firebase
    try {
      app = firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      console.log('‚úÖ Firebase initialis√© pour consultation');
    } catch (error) {
      console.error('‚ùå Erreur Firebase:', error);
      alert('Erreur de connexion √† la base de donn√©es');
    }
    
    // Charger toutes les donn√©es
    async function loadData() {
      if (!db) return;
      
      document.getElementById('loading').style.display = 'block';
      
      try {
        const snapshot = await db.ref('sessions').once('value');
        
        if (!snapshot.exists()) {
          document.getElementById('no-results').style.display = 'block';
          document.getElementById('loading').style.display = 'none';
          return;
        }
        
        const sessions = snapshot.val();
        allSessions = [];
        
        // Transformer les donn√©es Firebase en tableau utilisable
        Object.entries(sessions).forEach(([key, session]) => {
          if (!session.meta || !session.palanquees) return;
          
          const sessionData = {
            id: key,
            date: session.meta.date,
            dp: session.meta.dp,
            lieu: session.meta.lieu,
            typeSession: session.meta.plongee || 'matin',
            palanquees: []
          };
          
          // Ajouter chaque palanqu√©e
          session.palanquees.forEach((palanquee, idx) => {
            if (!palanquee || !palanquee.plongeurs) return;
            
            sessionData.palanquees.push({
              numero: idx + 1,
              horaire: palanquee.parametres?.horaire || '',
              profPrevue: palanquee.parametres?.profondeurPrevue || '',
              dureePrevue: palanquee.parametres?.dureePrevue || '',
              profRealisee: palanquee.parametres?.profondeurRealisee || '',
              dureeRealisee: palanquee.parametres?.dureeRealisee || '',
              paliers: palanquee.parametres?.paliers || '',
              plongeurs: palanquee.plongeurs || []
            });
          });
          
          if (sessionData.palanquees.length > 0) {
            allSessions.push(sessionData);
          }
        });
        
        // Trier par date d√©croissante
        allSessions.sort((a, b) => b.date.localeCompare(a.date));
        
        // Charger les lieux uniques pour le filtre
        loadLieux();
        
        // Afficher toutes les sessions
        displaySessions(allSessions);
        updateStats(allSessions);
        
      } catch (error) {
        console.error('Erreur chargement:', error);
        alert('Erreur lors du chargement des donn√©es');
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }
    
    // Charger les lieux pour le filtre
    function loadLieux() {
      const lieux = new Set();
      allSessions.forEach(session => {
        if (session.lieu) {
          lieux.add(session.lieu);
        }
      });
      
      const lieuSelect = document.getElementById('search-lieu');
      lieuSelect.innerHTML = '<option value="">Tous les lieux</option>';
      
      Array.from(lieux).sort().forEach(lieu => {
        const option = document.createElement('option');
        option.value = lieu;
        option.textContent = lieu;
        lieuSelect.appendChild(option);
      });
    }
    
    // Afficher les sessions
    function displaySessions(sessions) {
      const container = document.getElementById('palanquees-container');
      const noResults = document.getElementById('no-results');
      
      if (sessions.length === 0) {
        container.innerHTML = '';
        noResults.style.display = 'block';
        return;
      }
      
      noResults.style.display = 'none';
      container.innerHTML = sessions.map(session => {
        const dateObj = new Date(session.date);
        const dateFormatted = dateObj.toLocaleDateString('fr-FR', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        return session.palanquees.map(palanquee => `
          <div class="palanquee-card">
            <div class="session-header">
              <div class="session-date">üìÖ ${dateFormatted}</div>
              <div class="session-info">
                <span>üìç ${session.lieu}</span>
                <span>üë®‚Äç‚úàÔ∏è ${session.dp}</span>
              </div>
            </div>
            
            <div class="palanquee-title">
              Palanqu√©e #${palanquee.numero} - ${session.typeSession}
            </div>
            
            <div class="palanquee-details">
              ${palanquee.horaire ? `
                <div class="detail-row">
                  <span class="detail-icon">üïê</span>
                  <span class="detail-label">Horaire:</span>
                  <span class="detail-value">${palanquee.horaire}</span>
                </div>
              ` : ''}
              
              ${palanquee.profPrevue ? `
                <div class="detail-row">
                  <span class="detail-icon">üåä</span>
                  <span class="detail-label">Prof. pr√©vue:</span>
                  <span class="detail-value">${palanquee.profPrevue} m</span>
                </div>
              ` : ''}
              
              ${palanquee.dureePrevue ? `
                <div class="detail-row">
                  <span class="detail-icon">‚è±Ô∏è</span>
                  <span class="detail-label">Dur√©e pr√©vue:</span>
                  <span class="detail-value">${palanquee.dureePrevue} min</span>
                </div>
              ` : ''}
            </div>
            
            <div class="plongeurs-list">
              <div class="plongeurs-title">üë• Plongeurs (${palanquee.plongeurs.length})</div>
              ${palanquee.plongeurs.map(plongeur => `
                <div class="plongeur-item">
                  <span class="plongeur-name">${plongeur.nom}</span>
                  <div class="plongeur-badges">
                    ${plongeur.pre ? `<span class="pre-badge">${plongeur.pre}</span>` : ''}
                    <span class="niveau-badge">${plongeur.niveau}</span>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `).join('');
      }).join('');
    }
    
    // Rechercher les palanqu√©es
    function searchPalanquees() {
      const name = document.getElementById('search-name').value.toLowerCase();
      const date = document.getElementById('search-date').value;
      const lieu = document.getElementById('search-lieu').value;
      
      filteredSessions = allSessions.filter(session => {
        // Filtre par lieu
        if (lieu && session.lieu !== lieu) return false;
        
        // Filtre par date
        if (date && session.date !== date) return false;
        
        // Filtre par nom (dans n'importe quelle palanqu√©e)
        if (name) {
          const hasName = session.palanquees.some(palanquee =>
            palanquee.plongeurs.some(plongeur =>
              plongeur.nom.toLowerCase().includes(name)
            )
          );
          if (!hasName) return false;
        }
        
        return true;
      });
      
      // Si on cherche par nom, ne garder que les palanqu√©es concern√©es
      if (name) {
        filteredSessions = filteredSessions.map(session => ({
          ...session,
          palanquees: session.palanquees.filter(palanquee =>
            palanquee.plongeurs.some(plongeur =>
              plongeur.nom.toLowerCase().includes(name)
            )
          )
        }));
      }
      
      displaySessions(filteredSessions);
      updateStats(filteredSessions);
    }
    
    // Filtres rapides
    function filterToday(chip) {
      resetChips();
      chip.classList.add('active');
      const today = new Date().toISOString().split('T')[0];
      filteredSessions = allSessions.filter(s => s.date === today);
      displaySessions(filteredSessions);
      updateStats(filteredSessions);
    }
    
    function filterWeek(chip) {
      resetChips();
      chip.classList.add('active');
      const today = new Date();
      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      filteredSessions = allSessions.filter(s => {
        const sDate = new Date(s.date);
        return sDate >= weekAgo && sDate <= today;
      });
      displaySessions(filteredSessions);
      updateStats(filteredSessions);
    }
    
    function filterMonth(chip) {
      resetChips();
      chip.classList.add('active');
      const today = new Date();
      const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
      filteredSessions = allSessions.filter(s => {
        const sDate = new Date(s.date);
        return sDate >= monthAgo && sDate <= today;
      });
      displaySessions(filteredSessions);
      updateStats(filteredSessions);
    }
    
    function filterMyPalanquees(chip) {
      const name = prompt('Entrez votre nom complet:');
      if (name) {
        resetChips();
        chip.classList.add('active');
        document.getElementById('search-name').value = name;
        searchPalanquees();
      }
    }
    
    function showAll(chip) {
      resetChips();
      chip.classList.add('active');
      document.getElementById('search-name').value = '';
      document.getElementById('search-date').value = '';
      document.getElementById('search-lieu').value = '';
      displaySessions(allSessions);
      updateStats(allSessions);
    }
    
    function resetChips() {
      document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    }
    
    // Mettre √† jour les statistiques
    function updateStats(sessions) {
      const today = new Date().toISOString().split('T')[0];
      const weekAgo = new Date(new Date().getTime() - 7 * 24 * 60 * 60 * 1000);
      
      // Total sessions
      document.getElementById('stat-total').textContent = sessions.length;
      
      // Sessions aujourd'hui
      document.getElementById('stat-today').textContent = 
        sessions.filter(s => s.date === today).length;
      
      // Sessions cette semaine
      document.getElementById('stat-week').textContent = 
        sessions.filter(s => {
          const sDate = new Date(s.date);
          return sDate >= weekAgo;
        }).length;
      
      // Plongeurs uniques
      const uniquePlongeurs = new Set();
      sessions.forEach(session => {
        session.palanquees.forEach(palanquee => {
          palanquee.plongeurs.forEach(plongeur => {
            uniquePlongeurs.add(plongeur.nom);
          });
        });
      });
      document.getElementById('stat-plongeurs').textContent = uniquePlongeurs.size;
    }
    
    // Rafra√Æchir les donn√©es
    function refreshData() {
      const btn = document.querySelector('.refresh-btn');
      btn.style.transform = 'rotate(360deg)';
      setTimeout(() => {
        loadData();
        btn.style.transform = 'rotate(0deg)';
      }, 500);
    }
    
    // Charger au d√©marrage
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      
      // Auto-refresh toutes les 5 minutes
      setInterval(loadData, 5 * 60 * 1000);
    });
  </script>
</body>
</html>