<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Nouveau mot de passe</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 300px;
        }
        
        h1 {
            font-size: 24px;
            margin: 0;
            text-align: center;
            color: #333;
        }
        
        input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            width: 250px;
            text-align: center;
        }
        
        input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        button {
            padding: 12px 24px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        #message {
            text-align: center;
            margin: 0;
            font-size: 14px;
            color: #666;
        }
        
        .success {
            color: #28a745 !important;
        }
        
        .error {
            color: #dc3545 !important;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Étape 1: Vérification du code -->
        <div id="verifySection">
            <h1>Vérification en cours...</h1>
            <p id="verifyMessage">Validation du lien de réinitialisation...</p>
        </div>
        
        <!-- Étape 2: Saisie du nouveau mot de passe -->
        <div id="resetSection" class="hidden">
            <h1>Nouveau mot de passe</h1>
            <input type="password" id="newPassword" placeholder="Nouveau mot de passe" />
            </br><input type="password" id="confirmPassword" placeholder="Confirmer le mot de passe" />
            </br><button onclick="confirmReset()">Changer le mot de passe</button>
            <p id="resetMessage"></p>
        </div>
        
        <!-- Étape 3: Confirmation -->
        <div id="successSection" class="hidden">
            <h1>✅ Mot de passe changé</h1>
            <p>Votre mot de passe a été modifié avec succès.</p>
            </br><button onclick="redirectToLogin()">Se connecter</button>
        </div>
    </div>

    <script>
        // Configuration Firebase
        var firebaseConfig = {
            apiKey: "AIzaSyA9FO6BiHkm7dOQ3Z4-wpPQRgnsGKg3pmM",
            authDomain: "palanquees-jsas.firebaseapp.com",
            databaseURL: "https://palanquees-jsas-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "palanquees-jsas",
            storageBucket: "palanquees-jsas.firebasestorage.app",
            messagingSenderId: "284449736616",
            appId: "1:284449736616:web:a0949a9b669def06323f9d"
        };
        firebase.initializeApp(firebaseConfig);

        let actionCode = null;

        // Vérifier le code de reset au chargement de la page
        window.onload = function() {
            verifyResetCode();
        };

        function verifyResetCode() {
            // Récupérer les paramètres de l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            actionCode = urlParams.get('oobCode');
            
            const verifyMessage = document.getElementById('verifyMessage');
            
            if (mode !== 'resetPassword' || !actionCode) {
                verifyMessage.innerHTML = '<span class="error">Lien de réinitialisation invalide</span>';
                return;
            }
            
            // Vérifier la validité du code avec Firebase
            firebase.auth().verifyPasswordResetCode(actionCode)
                .then(function(email) {
                    verifyMessage.innerHTML = `<span class="success">Lien valide pour ${email}</span>`;
                    
                    // Afficher la section de reset
                    document.getElementById('verifySection').classList.add('hidden');
                    document.getElementById('resetSection').classList.remove('hidden');
                })
                .catch(function(error) {
                    let errorMsg = "Code de réinitialisation invalide ou expiré";
                    if (error.code === 'auth/expired-action-code') {
                        errorMsg = "Le lien a expiré. Demandez un nouveau lien de réinitialisation.";
                    }
                    verifyMessage.innerHTML = `<span class="error">${errorMsg}</span>`;
                });
        }

        function confirmReset() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const resetMessage = document.getElementById('resetMessage');
            
            // Validation
            if (!newPassword || !confirmPassword) {
                resetMessage.innerHTML = '<span class="error">Veuillez remplir tous les champs</span>';
                resetMessage.className = "error";
                return;
            }
            
            if (newPassword !== confirmPassword) {
                resetMessage.innerHTML = '<span class="error">Les mots de passe ne correspondent pas</span>';
                resetMessage.className = "error";
                return;
            }
            
            if (newPassword.length < 6) {
                resetMessage.innerHTML = '<span class="error">Le mot de passe doit contenir au moins 6 caractères</span>';
                resetMessage.className = "error";
                return;
            }
            
            resetMessage.innerHTML = '<span class="loading">Changement en cours...</span>';
            
            // Confirmer le nouveau mot de passe avec Firebase
            firebase.auth().confirmPasswordReset(actionCode, newPassword)
                .then(function() {
                    // Succès - afficher la section de confirmation
                    document.getElementById('resetSection').classList.add('hidden');
                    document.getElementById('successSection').classList.remove('hidden');
                })
                .catch(function(error) {
                    let errorMsg = "Erreur lors du changement du mot de passe";
                    if (error.code === 'auth/weak-password') {
                        errorMsg = "Le mot de passe est trop faible";
                    } else if (error.code === 'auth/expired-action-code') {
                        errorMsg = "Le lien a expiré";
                    }
                    resetMessage.innerHTML = `<span class="error">${errorMsg}</span>`;
                    resetMessage.className = "error";
                });
        }

        function redirectToLogin() {
            // Rediriger vers votre page de connexion
            window.location.href = 'index.html'; // Changez selon votre structure
        }
    </script>
</body>
</html>