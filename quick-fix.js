// quick-fix.js - Script de correction rapide pour r√©soudre les erreurs de syntaxe

console.log("üîß Script de correction rapide JSAS en cours...");

// ===== V√âRIFICATION ET CORRECTION DES ERREURS DE SYNTAXE =====

// 1. V√©rifier que toutes les variables globales sont d√©finies
function initializeGlobalVariablesSafe() {
  if (typeof window.plongeurs === 'undefined') {
    window.plongeurs = [];
    console.log("‚úÖ Variable plongeurs initialis√©e");
  }
  
  if (typeof window.palanquees === 'undefined') {
    window.palanquees = [];
    console.log("‚úÖ Variable palanquees initialis√©e");
  }
  
  if (typeof window.plongeursOriginaux === 'undefined') {
    window.plongeursOriginaux = [];
    console.log("‚úÖ Variable plongeursOriginaux initialis√©e");
  }
  
  if (typeof window.currentUser === 'undefined') {
    window.currentUser = null;
    console.log("‚úÖ Variable currentUser initialis√©e");
  }
  
  if (typeof window.firebaseConnected === 'undefined') {
    window.firebaseConnected = false;
    console.log("‚úÖ Variable firebaseConnected initialis√©e");
  }
  
  if (typeof window.palanqueeLocks === 'undefined') {
    window.palanqueeLocks = {};
    console.log("‚úÖ Variable palanqueeLocks initialis√©e");
  }
  
  if (typeof window.currentlyEditingPalanquee === 'undefined') {
    window.currentlyEditingPalanquee = null;
    console.log("‚úÖ Variable currentlyEditingPalanquee initialis√©e");
  }
  
  if (typeof window.lockTimers === 'undefined') {
    window.lockTimers = {};
    console.log("‚úÖ Variable lockTimers initialis√©e");
  }
  
  if (typeof window.dpInfo === 'undefined') {
    window.dpInfo = { niveau: 'DP', nom: '' };
    console.log("‚úÖ Variable dpInfo initialis√©e");
  }
  
  if (typeof window.lockSystemInitialized === 'undefined') {
    window.lockSystemInitialized = false;
    console.log("‚úÖ Variable lockSystemInitialized initialis√©e");
  }
  
  if (typeof window.currentSort === 'undefined') {
    window.currentSort = 'none';
    console.log("‚úÖ Variable currentSort initialis√©e");
  }
  
  if (typeof window.pageLoadTime === 'undefined') {
    window.pageLoadTime = Date.now();
    console.log("‚úÖ Variable pageLoadTime initialis√©e");
  }
}

// 2. Gestionnaire d'erreurs simple et robuste
function simpleErrorHandler(error, context = "Application") {
  console.error(`‚ùå Erreur ${context}:`, error);
  
  // Messages d'erreur simplifi√©s
  const errorMessages = {
    'auth/user-not-found': 'Utilisateur non trouv√©',
    'auth/wrong-password': 'Mot de passe incorrect',
    'auth/too-many-requests': 'Trop de tentatives',
    'PERMISSION_DENIED': 'Acc√®s refus√©',
    'NETWORK_ERROR': 'Probl√®me de connexion'
  };
  
  const message = errorMessages[error.code] || error.message || 'Erreur inconnue';
  
  // Notification simple
  if (typeof showNotification === 'function') {
    showNotification(`üî• ${message}`, 'error');
  }
  
  return message;
}

// 3. Test de connexion Firebase simplifi√©
async function testFirebaseConnectionSimple() {
  try {
    if (typeof db === 'undefined' || !db) {
      console.warn("‚ö†Ô∏è Firebase DB non disponible");
      return false;
    }
    
    // Test simple avec timeout court
    const connected = await new Promise((resolve) => {
      const timeout = setTimeout(() => resolve(false), 3000);
      
      db.ref('.info/connected').once('value', (snapshot) => {
        clearTimeout(timeout);
        resolve(snapshot.val() === true);
      }, () => {
        clearTimeout(timeout);
        resolve(false);
      });
    });
    
    window.firebaseConnected = connected;
    console.log(connected ? "‚úÖ Firebase connect√©" : "‚ö†Ô∏è Firebase d√©connect√©");
    return connected;
    
  } catch (error) {
    console.error("‚ùå Test Firebase √©chou√©:", error);
    window.firebaseConnected = false;
    return false;
  }
}

// 4. Fonction de synchronisation simplifi√©e
async function simpleSyncToDatabase() {
  if (!window.firebaseConnected || typeof db === 'undefined' || !db) {
    console.warn("‚ö†Ô∏è Synchronisation ignor√©e - Firebase non disponible");
    return;
  }
  
  try {
    // Synchronisation simple
    await Promise.all([
      db.ref('plongeurs').set(window.plongeurs || []),
      db.ref('palanquees').set(window.palanquees || [])
    ]);
    
    console.log("‚úÖ Synchronisation r√©ussie");
    
    // Mettre √† jour le rendu si les fonctions existent
    if (typeof renderPalanquees === 'function') {
      renderPalanquees();
    }
    if (typeof renderPlongeurs === 'function') {
      renderPlongeurs();
    }
    if (typeof updateAlertes === 'function') {
      updateAlertes();
    }
    if (typeof updateCompteurs === 'function') {
      updateCompteurs();
    }
    
  } catch (error) {
    simpleErrorHandler(error, 'Synchronisation');
  }
}

// 5. Chargement des donn√©es simplifi√©
async function simpleLoadFromFirebase() {
  if (!window.firebaseConnected || typeof db === 'undefined' || !db) {
    console.warn("‚ö†Ô∏è Chargement ignor√© - Firebase non disponible");
    return;
  }
  
  try {
    console.log("üì• Chargement des donn√©es...");
    
    // Charger les plongeurs
    const plongeursSnapshot = await db.ref('plongeurs').once('value');
    if (plongeursSnapshot.exists()) {
      window.plongeurs = plongeursSnapshot.val() || [];
      window.plongeursOriginaux = [...window.plongeurs];
      console.log(`‚úÖ ${window.plongeurs.length} plongeurs charg√©s`);
    }
    
    // Charger les palanqu√©es
    const palanqueesSnapshot = await db.ref('palanquees').once('value');
    if (palanqueesSnapshot.exists()) {
      const rawPalanquees = palanqueesSnapshot.val() || [];
      
      // Correction simple des palanqu√©es
      window.palanquees = rawPalanquees.map((pal, index) => {
        if (Array.isArray(pal)) {
          // Ajouter les propri√©t√©s manquantes
          if (!pal.hasOwnProperty('horaire')) pal.horaire = '';
          if (!pal.hasOwnProperty('profondeurPrevue')) pal.profondeurPrevue = '';
          if (!pal.hasOwnProperty('dureePrevue')) pal.dureePrevue = '';
          if (!pal.hasOwnProperty('profondeurRealisee')) pal.profondeurRealisee = '';
          if (!pal.hasOwnProperty('dureeRealisee')) pal.dureeRealisee = '';
          if (!pal.hasOwnProperty('paliers')) pal.paliers = '';
          return pal;
        } else {
          // Cr√©er un tableau vide avec propri√©t√©s
          const nouveauTableau = [];
          nouveauTableau.horaire = '';
          nouveauTableau.profondeurPrevue = '';
          nouveauTableau.dureePrevue = '';
          nouveauTableau.profondeurRealisee = '';
          nouveauTableau.dureeRealisee = '';
          nouveauTableau.paliers = '';
          return nouveauTableau;
        }
      });
      
      console.log(`‚úÖ ${window.palanquees.length} palanqu√©es charg√©es`);
    }
    
    // Rendu
    if (typeof renderPalanquees === 'function') {
      renderPalanquees();
    }
    if (typeof renderPlongeurs === 'function') {
      renderPlongeurs();
    }
    
  } catch (error) {
    simpleErrorHandler(error, 'Chargement donn√©es');
  }
}

// 6. Gestionnaire d'erreurs globales
function setupGlobalErrorHandlers() {
  // Intercepter les erreurs JavaScript
  window.addEventListener('error', (event) => {
    console.error("‚ùå Erreur JavaScript globale:", event.error);
    simpleErrorHandler(event.error, 'JavaScript Global');
  });
  
  // Intercepter les promesses rejet√©es
  window.addEventListener('unhandledrejection', (event) => {
    console.error("‚ùå Promise rejet√©e:", event.reason);
    simpleErrorHandler(event.reason, 'Promise rejet√©e');
    event.preventDefault();
  });
  
  console.log("‚úÖ Gestionnaires d'erreurs globaux install√©s");
}

// 7. Fonction de nettoyage s√©curis√©e
function safeCleanup() {
  try {
    // Nettoyer les timers
    if (window.lockTimers && typeof window.lockTimers === 'object') {
      Object.values(window.lockTimers).forEach(timer => {
        if (timer) {
          clearTimeout(timer);
        }
      });
      window.lockTimers = {};
    }
    
    // R√©initialiser les verrous
    window.currentlyEditingPalanquee = null;
    window.palanqueeLocks = {};
    
    console.log("‚úÖ Nettoyage s√©curis√© effectu√©");
  } catch (error) {
    console.error("‚ùå Erreur lors du nettoyage:", error);
  }
}

// 8. Fonction de diagnostic rapide
function quickDiagnostic() {
  console.log("üîç === DIAGNOSTIC RAPIDE ===");
  
  const diagnostic = {
    variables: {
      plongeurs: typeof window.plongeurs !== 'undefined' ? window.plongeurs.length : 'undefined',
      palanquees: typeof window.palanquees !== 'undefined' ? window.palanquees.length : 'undefined',
      currentUser: typeof window.currentUser !== 'undefined' ? (window.currentUser ? 'connect√©' : 'null') : 'undefined',
      firebaseConnected: typeof window.firebaseConnected !== 'undefined' ? window.firebaseConnected : 'undefined'
    },
    firebase: {
      app: typeof firebase !== 'undefined' ? 'disponible' : 'undefined',
      db: typeof db !== 'undefined' ? 'disponible' : 'undefined',
      auth: typeof auth !== 'undefined' ? 'disponible' : 'undefined'
    },
    functions: {
      renderPalanquees: typeof renderPalanquees === 'function',
      renderPlongeurs: typeof renderPlongeurs === 'function',
      syncToDatabase: typeof syncToDatabase === 'function',
      initializeFirebase: typeof initializeFirebase === 'function'
    }
  };
  
  console.log("üìä Diagnostic:", diagnostic);
  console.log("======================");
  
  return diagnostic;
}

// ===== INITIALISATION DU SCRIPT DE CORRECTION =====

// Ex√©cuter imm√©diatement les corrections
initializeGlobalVariablesSafe();
setupGlobalErrorHandlers();

// Remplacer les fonctions probl√©matiques par des versions s√©curis√©es
if (typeof window.syncToDatabase === 'undefined') {
  window.syncToDatabase = simpleSyncToDatabase;
  console.log("‚úÖ syncToDatabase remplac√©e par version s√©curis√©e");
}

// Ajouter les fonctions utilitaires globales
window.simpleErrorHandler = simpleErrorHandler;
window.testFirebaseConnectionSimple = testFirebaseConnectionSimple;
window.simpleLoadFromFirebase = simpleLoadFromFirebase;
window.safeCleanup = safeCleanup;
window.quickDiagnostic = quickDiagnostic;

// Fonction d'urgence pour r√©cup√©rer l'application
window.emergencyRecovery = function() {
  console.log("üÜò === R√âCUP√âRATION D'URGENCE ===");
  
  try {
    // 1. R√©initialiser les variables
    initializeGlobalVariablesSafe();
    
    // 2. Nettoyer l'√©tat
    safeCleanup();
    
    // 3. Tester Firebase
    testFirebaseConnectionSimple();
    
    // 4. Recharger les donn√©es si possible
    if (window.firebaseConnected) {
      simpleLoadFromFirebase();
    }
    
    // 5. Diagnostic
    const diagnostic = quickDiagnostic();
    
    console.log("‚úÖ R√©cup√©ration d'urgence termin√©e");
    alert("üÜò R√©cup√©ration d'urgence effectu√©e.\nConsultez la console pour les d√©tails.");
    
    return diagnostic;
    
  } catch (error) {
    console.error("‚ùå Erreur lors de la r√©cup√©ration d'urgence:", error);
    alert("‚ùå R√©cup√©ration d'urgence √©chou√©e: " + error.message);
    return null;
  }
};

// Message de confirmation
console.log(`
‚úÖ === SCRIPT DE CORRECTION RAPIDE CHARG√â ===

Fonctions disponibles:
‚Ä¢ quickDiagnostic() - Diagnostic rapide
‚Ä¢ emergencyRecovery() - R√©cup√©ration d'urgence
‚Ä¢ safeCleanup() - Nettoyage s√©curis√©
‚Ä¢ testFirebaseConnectionSimple() - Test Firebase

Le script a automatiquement:
‚úÖ Initialis√© toutes les variables globales
‚úÖ Install√© les gestionnaires d'erreurs
‚úÖ Remplac√© les fonctions probl√©matiques
‚úÖ Ajout√© des fonctions de r√©cup√©ration

En cas de probl√®me, utilisez: emergencyRecovery()
============================================
`);

console.log("‚úÖ Script de correction rapide JSAS charg√© - Version 1.0.0");

// Auto-diagnostic au chargement
setTimeout(() => {
  quickDiagnostic();
}, 1000);