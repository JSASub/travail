<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë• Administration des DP - JSAS</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #004080 0%, #007bff 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .nav-buttons {
            margin-top: 20px;
        }
        
        .nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .content {
            padding: 30px;
        }
        
        .sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e9ecef;
        }
        
        .section h2 {
            color: #004080;
            margin-bottom: 20px;
            font-size: 24px;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        
        .dp-grid {
            display: grid;
            gap: 15px;
        }
        
        .dp-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .dp-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .dp-card.initial {
            border-left: 5px solid #28a745;
        }
        
        .dp-card.added {
            border-left: 5px solid #007bff;
        }
        
        .dp-info {
            flex: 1;
        }
        
        .dp-name {
            font-size: 18px;
            font-weight: bold;
            color: #004080;
            margin-bottom: 5px;
        }
        
        .dp-details {
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dp-level {
            background: #28a745;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .dp-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            transform: scale(1.05);
        }
        
        .btn-edit {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .add-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px dashed #007bff;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
        }
        
        .add-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
            text-align: left;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: bold;
            color: #004080;
            margin-bottom: 5px;
        }
        
        .form-group input, .form-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }
        
        .stats {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
            display: block;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .sections {
                grid-template-columns: 1fr;
            }
            
            .add-form {
                grid-template-columns: 1fr;
            }
            
            .dp-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .dp-actions {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë• Administration des Directeurs de Plong√©e</h1>
            <p>Gestion compl√®te de la liste des DP JSAS - Tous modifiables</p>
            <div class="nav-buttons">
                <a href="index.html" class="nav-btn">üè† Retour √† l'application</a>
                <button onclick="exportDPList()" class="nav-btn">üì• Exporter la liste</button>
                <button onclick="importDPList()" class="nav-btn">üì§ Importer</button>
            </div>
        </div>
        
        <div class="content">
            <!-- Statistiques -->
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-number" id="total-dps">0</span>
                    <span class="stat-label">DP Total</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="official-dps">0</span>
                    <span class="stat-label">DP de Base</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="custom-dps">0</span>
                    <span class="stat-label">DP Ajout√©s</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="e3-count">0</span>
                    <span class="stat-label">Niveau E3</span>
                </div>
            </div>
            
            <!-- Zones d'alerte -->
            <div id="alert-container"></div>
            
            <!-- Sections principales -->
            <div class="sections">
                <!-- DP de Base -->
                <div class="section">
                    <h2>üèõÔ∏è DP de Base JSAS</h2>
                    <div id="official-dps-container" class="dp-grid">
                        <div class="loading">üìã Chargement des DP de base...</div>
                    </div>
                </div>
                
                <!-- DP Ajout√©s -->
                <div class="section">
                    <h2>‚ûï DP Ajout√©s</h2>
                    <div id="custom-dps-container" class="dp-grid">
                        <div class="loading">üìÑ Chargement des DP ajout√©s...</div>
                    </div>
                </div>
            </div>
            
            <!-- Formulaire d'ajout -->
            <div class="add-section">
                <h2>‚ûï Ajouter un nouveau Directeur de Plong√©e</h2>
                <p>Ajoutez un DP √† votre liste - Tous les DP peuvent √™tre modifi√©s ou supprim√©s</p>
                
                <form id="add-dp-form" class="add-form">
                    <div class="form-group">
                        <label for="dp-nom">Nom *</label>
                        <input type="text" id="dp-nom" required placeholder="NOM" style="text-transform: uppercase;">
                    </div>
                    
                    <div class="form-group">
                        <label for="dp-prenom">Pr√©nom *</label>
                        <input type="text" id="dp-prenom" required placeholder="Pr√©nom">
                    </div>
                    
                    <div class="form-group">
                        <label for="dp-niveau">Niveau *</label>
                        <select id="dp-niveau" required>
                            <option value="">-- S√©lectionner --</option>
                            <option value="E4">E4 (Encadrant 4√®me degr√©)</option>
                            <option value="E3">E3 (Encadrant 3√®me degr√©)</option>
                            <option value="P5">P5 (Plongeur 5√®me degr√©)</option>
                            <option value="N5">N5 (Niveau 5)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="dp-email">Email</label>
                        <input type="email" id="dp-email" placeholder="email@jsas.fr (optionnel)">
                    </div>
                    
                    <div class="form-group" style="display: flex; align-items: end;">
                        <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                            ‚ûï Ajouter ce DP
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuration Firebase (m√™me que l'app principale)
        const firebaseConfig = {
            apiKey: "AIzaSyA9FO6BiHkm7dOQ3Z4-wpPQRgnsGKg3pmM",
            authDomain: "palanquees-jsas.firebaseapp.com",
            databaseURL: "https://palanquees-jsas-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "palanquees-jsas",
            storageBucket: "palanquees-jsas.firebasestorage.app",
            messagingSenderId: "284449736616",
            appId: "1:284449736616:web:a0949a9b669def06323f9d"
        };

        // Variables globales
        let app, db, auth;
        let currentUser = null;
        let allDPList = []; // Liste unique de tous les DP
        
        // DP de base pour l'initialisation
        const DP_INITIAUX = [
            { nom: "AGUIRRE", prenom: "Raoul", niveau: "E3", email: "raoul.aguirre64@gmail.com", type: "initial" },
            { nom: "AUBARD", prenom: "Corinne", niveau: "P5", email: "aubard.c@gmail.com", type: "initial" },
            { nom: "BEST", prenom: "S√©bastien", niveau: "P5", email: "sebastien.best@cma-nouvelleaquitaine.fr", type: "initial" },
            { nom: "CABIROL", prenom: "Jo√´l", niveau: "E3", email: "joelcabirol@gmail.com", type: "initial" },
            { nom: "CATTEROU", prenom: "Sacha", niveau: "P5", email: "sacha.catterou@orange.fr", type: "initial" },
            { nom: "DARDER", prenom: "Olivier", niveau: "P5", email: "olivierdarder@gmail.com", type: "initial" },
            { nom: "GAUTHIER", prenom: "Christophe", niveau: "P5", email: "cattof24@yahoo.fr", type: "initial" },
            { nom: "LE MAOUT", prenom: "Jean-Fran√ßois", niveau: "P5", email: "jf.lemaout@wanadoo.fr", type: "initial" },
            { nom: "MARTY", prenom: "David", niveau: "E3", email: "david.marty@sfr.fr", type: "initial" },
            { nom: "TROUBADIS", prenom: "Guillaume", niveau: "P5", email: "guillaume.troubadis@gmail.com", type: "initial" }
        ];

        // Initialisation Firebase
        function initializeFirebase() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                auth = firebase.auth();
                
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = user;
                        console.log("‚úÖ Connect√©:", user.email);
                        loadDPData();
                    } else {
                        showAlert("‚ö†Ô∏è Vous devez √™tre connect√© pour acc√©der √† cette page", "error");
                        setTimeout(() => {
                            window.location.href = "index.html";
                        }, 3000);
                    }
                });
                
            } catch (error) {
                console.error("‚ùå Erreur Firebase:", error);
                showAlert("‚ùå Erreur de connexion √† Firebase", "error");
            }
        }

        // Chargement des donn√©es
        async function loadDPData() {
            try {
                // Charger la liste compl√®te des DP
                const snapshot = await db.ref('all_dps').once('value');
                if (snapshot.exists()) {
                    allDPList = snapshot.val() || [];
                } else {
                    // Premi√®re fois : initialiser avec les DP de base
                    console.log("üîß Initialisation de la liste DP avec les DP de base");
                    allDPList = [...DP_INITIAUX];
                    await db.ref('all_dps').set(allDPList);
                }
                
                // Afficher les donn√©es
                displayAllDPs();
                updateStats();
                
            } catch (error) {
                console.error("‚ùå Erreur chargement DP:", error);
                showAlert("‚ùå Erreur lors du chargement des donn√©es", "error");
            }
        }

        // Affichage de tous les DP
        function displayAllDPs() {
            const officialContainer = document.getElementById('official-dps-container');
            const customContainer = document.getElementById('custom-dps-container');
            
            // S√©parer les DP de base et les DP ajout√©s
            const initialDPs = allDPList.filter(dp => dp.type === 'initial');
            const addedDPs = allDPList.filter(dp => dp.type !== 'initial');
            
            // DP de base
            let officialHtml = '';
            initialDPs.forEach((dp, index) => {
                const realIndex = allDPList.findIndex(d => d === dp);
                officialHtml += createDPCard(dp, 'initial', realIndex);
            });
            officialContainer.innerHTML = officialHtml || '<div style="text-align: center; padding: 40px; color: #666;"><h3>Aucun DP de base</h3><p>Ajoutez des DP avec le formulaire</p></div>';
            
            // DP ajout√©s
            let customHtml = '';
            addedDPs.forEach((dp, index) => {
                const realIndex = allDPList.findIndex(d => d === dp);
                customHtml += createDPCard(dp, 'added', realIndex);
            });
            customContainer.innerHTML = customHtml || '<div style="text-align: center; padding: 40px; color: #666;"><h3>Aucun DP ajout√©</h3><p>Utilisez le formulaire ci-dessous pour ajouter des DP</p></div>';
        }

        // Cr√©ation d'une carte DP
        function createDPCard(dp, type, index = null) {
            const isInitial = type === 'initial';
            
            return `
                <div class="dp-card ${type}">
                    <div class="dp-info">
                        <div class="dp-name">${dp.nom} ${dp.prenom}</div>
                        <div class="dp-details">
                            <span class="dp-level">${dp.niveau}</span>
                            <span>${dp.email || 'Pas d\'email'}</span>
                            ${isInitial ? 
                                '<span style="font-size: 12px; color: #28a745; font-weight: bold;">DP de base</span>' : 
                                '<span style="font-size: 12px; color: #007bff; font-weight: bold;">DP ajout√©</span>'
                            }
                            ${dp.dateAjout ? '<span style="font-size: 12px; color: #999;">Ajout√© le ' + new Date(dp.dateAjout).toLocaleDateString('fr-FR') + '</span>' : ''}
                        </div>
                    </div>
                    <div class="dp-actions">
                        <button class="btn btn-edit" onclick="editDP(${index})" title="Modifier ce DP">
                            ‚úèÔ∏è Modifier
                        </button>
                        <button class="btn btn-delete" onclick="deleteDP(${index})" title="Supprimer ce DP">
                            üóëÔ∏è Supprimer
                        </button>
                    </div>
                </div>
            `;
        }

        // Mise √† jour des statistiques
        function updateStats() {
            const initialCount = allDPList.filter(dp => dp.type === 'initial').length;
            const addedCount = allDPList.filter(dp => dp.type !== 'initial').length;
            const totalDPs = allDPList.length;
            const e3Count = allDPList.filter(dp => dp.niveau === 'E3').length;
            
            document.getElementById('total-dps').textContent = totalDPs;
            document.getElementById('official-dps').textContent = initialCount;
            document.getElementById('custom-dps').textContent = addedCount;
            document.getElementById('e3-count').textContent = e3Count;
        }

        // Ajout d'un nouveau DP
        async function addDP(dpData) {
            try {
                // V√©rifier les doublons
                const exists = allDPList.some(dp => 
                    dp.nom.toLowerCase() === dpData.nom.toLowerCase() && 
                    dp.prenom.toLowerCase() === dpData.prenom.toLowerCase()
                );
                
                if (exists) {
                    showAlert("‚ö†Ô∏è Ce DP existe d√©j√† dans la liste !", "error");
                    return false;
                }
                
                // Ajouter la date et le type
                dpData.dateAjout = new Date().toISOString();
                dpData.type = 'added';
                
                // Ajouter √† la liste
                allDPList.push(dpData);
                
                // Sauvegarder
                await db.ref('all_dps').set(allDPList);
                
                // Rafra√Æchir l'affichage
                displayAllDPs();
                updateStats();
                
                showAlert(`‚úÖ DP "${dpData.nom} ${dpData.prenom}" ajout√© avec succ√®s !`, "success");
                return true;
                
            } catch (error) {
                console.error("‚ùå Erreur ajout DP:", error);
                showAlert("‚ùå Erreur lors de l'ajout du DP", "error");
                return false;
            }
        }

        // Suppression d'un DP
        async function deleteDP(index) {
            const dp = allDPList[index];
            
            if (!confirm(`‚ö†Ô∏è Supprimer "${dp.nom} ${dp.prenom}" de la liste ?\n\nCette action est irr√©versible !\n\n‚ö†Ô∏è ATTENTION : M√™me les DP de base peuvent √™tre supprim√©s.`)) {
                return;
            }
            
            try {
                allDPList.splice(index, 1);
                await db.ref('all_dps').set(allDPList);
                
                displayAllDPs();
                updateStats();
                
                showAlert(`‚úÖ DP "${dp.nom} ${dp.prenom}" supprim√© avec succ√®s !`, "success");
                
            } catch (error) {
                console.error("‚ùå Erreur suppression DP:", error);
                showAlert("‚ùå Erreur lors de la suppression du DP", "error");
            }
        }

        // Modification d'un DP
        function editDP(index) {
            const dp = allDPList[index];
            
            const newNom = prompt("Nom:", dp.nom);
            if (newNom === null) return;
            
            const newPrenom = prompt("Pr√©nom:", dp.prenom);
            if (newPrenom === null) return;
            
            const newNiveau = prompt("Niveau (E4/E3/P5/N5):", dp.niveau);
            if (newNiveau === null) return;
            
            const newEmail = prompt("Email:", dp.email || "");
            if (newEmail === null) return;
            
            // Validation basique
            if (!newNom.trim() || !newPrenom.trim() || !newNiveau.trim()) {
                alert("‚ö†Ô∏è Nom, pr√©nom et niveau sont obligatoires !");
                return;
            }
            
            if (!['E4', 'E3', 'P5', 'N5'].includes(newNiveau.trim())) {
                alert("‚ö†Ô∏è Niveau invalide ! Utilisez : E4, E3, P5 ou N5");
                return;
            }
            
            // Mettre √† jour
            allDPList[index] = {
                ...dp,
                nom: newNom.trim().toUpperCase(),
                prenom: newPrenom.trim(),
                niveau: newNiveau.trim(),
                email: newEmail.trim(),
                dateModification: new Date().toISOString()
            };
            
            // Sauvegarder et rafra√Æchir
            db.ref('all_dps').set(allDPList).then(() => {
                displayAllDPs();
                updateStats();
                showAlert("‚úÖ DP modifi√© avec succ√®s !", "success");
            }).catch(error => {
                console.error("‚ùå Erreur modification:", error);
                showAlert("‚ùå Erreur lors de la modification", "error");
            });
        }

        // Export de la liste
        function exportDPList() {
            const exportData = {
                exportDate: new Date().toISOString(),
                allDPs: allDPList,
                stats: {
                    total: allDPList.length,
                    initial: allDPList.filter(dp => dp.type === 'initial').length,
                    added: allDPList.filter(dp => dp.type !== 'initial').length
                }
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `dp-jsas-complet-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showAlert("üì• Liste compl√®te export√©e avec succ√®s !", "success");
        }

        // Import de la liste
        function importDPList() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (data.allDPs && Array.isArray(data.allDPs)) {
                        const confirm = window.confirm(`‚ö†Ô∏è Importer ${data.allDPs.length} DP ?\n\nCela √©crasera votre liste actuelle !\n\nCette action est irr√©versible.`);
                        
                        if (confirm) {
                            allDPList = data.allDPs;
                            await db.ref('all_dps').set(allDPList);
                            
                            displayAllDPs();
                            updateStats();
                            
                            showAlert("üì§ Import r√©ussi !", "success");
                        }
                    } else {
                        showAlert("‚ö†Ô∏è Format de fichier invalide", "error");
                    }
                } catch (error) {
                    console.error("‚ùå Erreur import:", error);
                    showAlert("‚ùå Erreur lors de l'import", "error");
                }
            };
            input.click();
        }

        // Affichage des alertes
        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 5000);
        }

        // Event listeners
        document.getElementById('add-dp-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nom = document.getElementById('dp-nom').value.trim().toUpperCase();
            const prenom = document.getElementById('dp-prenom').value.trim();
            const niveau = document.getElementById('dp-niveau').value;
            const email = document.getElementById('dp-email').value.trim();
            
            if (!nom || !prenom || !niveau) {
                showAlert("‚ö†Ô∏è Veuillez remplir tous les champs obligatoires", "error");
                return;
            }
            
            const dpData = { nom, prenom, niveau, email };
            const success = await addDP(dpData);
            
            if (success) {
                document.getElementById('add-dp-form').reset();
            }
        });

        // Initialisation
        window.onload = initializeFirebase;
    </script>
</body>
</html>